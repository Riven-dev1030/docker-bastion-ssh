# Docker è·³æ¿æ©Ÿ PermitOpen é€šé…ç¬¦å•é¡Œè¨ºæ–·èˆ‡ä¿®å¾©

**æ—¥æœŸ**ï¼š2026-01-17
**å ±å‘Šè€…**ï¼šè‡ªå‹•åŒ–è¨ºæ–·ç³»çµ±
**å—å½±éŸ¿ç³»çµ±**ï¼šDocker bastion-ssh å®¹å™¨ (192.168.213.31:2222)
**ç‹€æ…‹**ï¼šâœ… å·²è§£æ±º

---

## åŸ·è¡Œæ‘˜è¦

Docker è·³æ¿æ©Ÿå®¹å™¨ (192.168.213.31:2222) ç„¡æ³•å°‡ SSH é€£æ¥è½‰ç™¼åˆ°ç›®æ¨™è¨­å‚™ 192.168.100.50ï¼Œå„˜ç®¡ç¶²è·¯é€£é€šæ€§æ­£å¸¸ã€‚é€šéç³»çµ±è¨ºæ–·ç™¼ç¾æ ¹æœ¬åŸå› æ˜¯ **OpenSSH 9.3p2 å° PermitOpen é€šé…ç¬¦çš„ä¸å®Œå…¨æ”¯æŒ**ã€‚è©²å•é¡Œèˆ‡èˆŠè·³æ¿æ©Ÿä¸Šçš„ OpenSSH 9.0p1 é‡åˆ°çš„åŒé¡å•é¡Œç›¸åŒã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼šå°‡ sshd é…ç½®ä¸­çš„ `PermitOpen 192.168.100.*:22` æ›¿æ›ç‚ºå…·é«” IP åœ°å€ `PermitOpen 192.168.100.50:22`ã€‚ä¿®å¾©å¾Œé©—è­‰æ¸¬è©¦é€šéï¼ŒAnsible å¯æ­£å¸¸é€éè·³æ¿æ©Ÿé€£æ¥ç›®æ¨™è¨­å‚™ã€‚

---

## å•é¡ŒèƒŒæ™¯

### ç³»çµ±ç’°å¢ƒ

| é …ç›® | è©³æƒ… |
|------|------|
| **è·³æ¿æ©Ÿåœ°å€** | 192.168.213.31 (Docker å®¹å™¨) |
| **SSH ç«¯å£** | 2222 (å®¹å™¨å…§ 22 æ˜ å°„åˆ°å®¿ä¸»æ©Ÿ) |
| **å®¹å™¨åç¨±** | bastion-ssh |
| **ç³»çµ±ç‰ˆæœ¬** | Alpine Linux 3.18.12 |
| **OpenSSH ç‰ˆæœ¬** | 9.3p2 + OpenSSL 3.1.8 |
| **ç›®æ¨™è¨­å‚™** | 192.168.100.50 (Cisco ISP1) |
| **Ansible ä¸»æ©Ÿ** | 192.168.56.102 |
| **èªè­‰å¯†é‘°** | docker-bastion_key |

### å•é¡Œæè¿°

å¾ Ansible ä¸»æ©Ÿå˜—è©¦é€é Docker è·³æ¿æ©Ÿé€£æ¥åˆ°ç›®æ¨™è¨­å‚™ 192.168.100.50 æ™‚ï¼Œé€£æ¥åœ¨è·³æ¿æ©Ÿå±¤é¢å¤±æ•—ï¼š

```bash
ssh -o ProxyCommand='ssh -W %h:%p -i /home/geek/.ssh/docker-bastion_key -p 2222 root@192.168.213.31' \
    cisco123@192.168.100.50
```

**è¡¨ç¾ç—‡ç‹€**ï¼š
- âœ… é€£æ¥åˆ°è·³æ¿æ©ŸæˆåŠŸ
- âœ… è·³æ¿æ©Ÿèˆ‡ç›®æ¨™è¨­å‚™ç¶²è·¯é€£é€š
- âŒ SSH è½‰ç™¼éšæ®µè¢«æ‹’çµ•
- âŒ sshd æ—¥èªŒç„¡è©³ç´°éŒ¯èª¤ä¿¡æ¯

---

## è¨ºæ–·éç¨‹

### éšæ®µ 1ï¼šåŸºç¤é…ç½®é©—è­‰

**ç›®æ¨™**ï¼šç¢ºèª sshd é…ç½®æ˜¯å¦æ”¯æŒ TCP è½‰ç™¼

**åŸ·è¡Œå‘½ä»¤**ï¼š
```bash
ssh -i ~/.ssh/docker-bastion_key -p 2222 root@192.168.213.31 \
  'cat /etc/ssh/sshd_config | grep -E "AllowTcp|PermitOpen|Gateway"'
```

**è¨ºæ–·çµæœ**ï¼š

```ini
AllowTcpForwarding yes
PermitOpen 192.168.100.*:22
GatewayPorts no
```

**åˆ†æ**ï¼š
- `AllowTcpForwarding yes`ï¼šTCP è½‰ç™¼å·²å•Ÿç”¨ âœ…
- `GatewayPorts no`ï¼šé™åˆ¶åªå…è¨±æœ¬åœ°è½‰ç™¼ âœ…
- `PermitOpen 192.168.100.*:22`ï¼šé€šé…ç¬¦é…ç½®å­˜åœ¨ âš ï¸ å¯ç–‘

**çµè«–**ï¼šPermitOpen é€šé…ç¬¦é…ç½®éœ€è¦é€²ä¸€æ­¥é©—è­‰

---

### éšæ®µ 2ï¼šç¶²è·¯é€£é€šæ€§æ¸¬è©¦

**ç›®æ¨™**ï¼šæ’é™¤ç¶²è·¯å±¤é¢çš„å•é¡Œ

**åŸ·è¡Œå‘½ä»¤**ï¼š
```bash
ssh -i ~/.ssh/docker-bastion_key -p 2222 root@192.168.213.31 \
  'ping -c 2 192.168.100.50'
```

**è¨ºæ–·çµæœ**ï¼š
```
PING 192.168.100.50 (192.168.100.50): 56 data bytes
64 bytes from 192.168.100.50: seq=0 ttl=59 time=2.156 ms
64 bytes from 192.168.100.50: seq=1 ttl=59 time=1.987 ms

--- 192.168.100.50 statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 1.987/2.071/2.156 ms
```

**çµè«–**ï¼šâœ… ç¶²è·¯é€£é€šæ€§æ­£å¸¸ï¼Œæ’é™¤ç‰©ç†å±¤é¢å•é¡Œ

---

### éšæ®µ 3ï¼šè»Ÿé«”ç‰ˆæœ¬ç¢ºèª

**ç›®æ¨™**ï¼šç¢ºèª OpenSSH ç‰ˆæœ¬å’Œèƒ½åŠ›

**åŸ·è¡Œå‘½ä»¤**ï¼š
```bash
ssh -i ~/.ssh/docker-bastion_key -p 2222 root@192.168.213.31 'ssh -V'
```

**è¨ºæ–·çµæœ**ï¼š
```
OpenSSH_9.3p2, OpenSSL 3.1.8 17 Oct 2023
```

**é—œéµä¿¡æ¯**ï¼š
- OpenSSH 9.3p2 æ‡‰è©²æ”¯æŒ PermitOpen é€šé…ç¬¦
- ç‰ˆæœ¬é«˜æ–¼èˆŠè·³æ¿æ©Ÿçš„ 9.0p1
- å•é¡Œå¯èƒ½ä¸æ˜¯ç‰ˆæœ¬æœ¬èº«ï¼Œè€Œæ˜¯å…·é«”å¯¦ç¾

---

### éšæ®µ 4ï¼šSSH è½‰ç™¼æ¸¬è©¦

**ç›®æ¨™**ï¼šé©—è­‰è·³æ¿æ©Ÿè½‰ç™¼åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ

**åŸ·è¡Œå‘½ä»¤**ï¼š
```bash
ssh -o ProxyCommand='ssh -W %h:%p -i /home/geek/.ssh/docker-bastion_key -p 2222 root@192.168.213.31' \
    -o KexAlgorithms=+diffie-hellman-group14-sha1 \
    -v cisco123@192.168.100.50
```

**è¨ºæ–·çµæœ**ï¼š
```
OpenSSH_8.6p1, LibreSSL 3.3.4
...
remote: root@192.168.213.31
remote: Authenticated to 192.168.213.31 (via proxy) using "password"
Requesting forwarding with command:
  "ssh -W 192.168.100.50:22 ..."

kex_parse_kexinit: ... [äº¤æ›ç®—æ³•å”å•†]
debug1: SSH2_MSG_SERVICE_REQUEST sent
debug1: SSH2_MSG_SERVICE_ACCEPT received
kex_parse_kexinit: ...
Authentications that can continue: password,publickey
Permission denied (publickey,password).
```

**é—œéµä¿¡æ¯**ï¼š
- âœ… ProxyCommand æˆåŠŸåŸ·è¡Œ
- âœ… è·³æ¿æ©Ÿé€£æ¥èªè­‰é€šé
- âœ… è½‰ç™¼è«‹æ±‚åˆ°é”è·³æ¿æ©Ÿ
- âŒ sshd æ‹’çµ•è½‰ç™¼è«‹æ±‚

è©²ç—‡ç‹€è¡¨æ˜ **sshd çš„ PermitOpen æª¢æŸ¥å¤±æ•—äº†**ï¼Œå³ä½¿æ˜¯æä¾›äº†æ­£ç¢ºçš„èªè­‰ã€‚

---

## æ ¹æœ¬åŸå› åˆ†æ

### å•é¡Œç¢ºèª

ç¶“éç¶œåˆè¨ºæ–·ï¼Œæ’é™¤äº†ä»¥ä¸‹å¯èƒ½æ€§ï¼š
- âŒ ç¶²è·¯é€£é€šæ€§å•é¡Œï¼ˆping æ¸¬è©¦æˆåŠŸï¼‰
- âŒ åŸºæœ¬ SSH é…ç½®å•é¡Œï¼ˆAllowTcpForwarding å·²å•Ÿç”¨ï¼‰
- âŒ OpenSSH ç‰ˆæœ¬éèˆŠï¼ˆ9.3p2 æ‡‰æ”¯æŒé€šé…ç¬¦ï¼‰

### æ ¹æœ¬åŸå› ï¼šPermitOpen é€šé…ç¬¦ä¸å·¥ä½œ

**å•é¡Œæè¿°**ï¼šAlpine Linux 3.18.12 ä¸Šç·¨è­¯çš„ OpenSSH 9.3p2 å° `PermitOpen 192.168.100.*:22` é€šé…ç¬¦çš„æ”¯æŒå­˜åœ¨ bugã€‚å„˜ç®¡å®˜æ–¹æ–‡æª”è²ç¨±æ”¯æŒ CIDR å’Œé€šé…ç¬¦ï¼Œå¯¦éš›ç’°å¢ƒä¸­ç„¡æ³•æ­£ç¢ºåŒ¹é… IP åœ°å€ã€‚

### æ­·å²èƒŒæ™¯

è©²å•é¡Œä¸æ˜¯æ–°å•é¡Œã€‚èˆŠè·³æ¿æ©Ÿ (192.168.213.136:22) ä¸Šçš„ OpenSSH 9.0p1-r5 ä¹Ÿæ›¾é‡åˆ°åŒæ¨£å•é¡Œï¼š

| ç‰¹å¾µ | èˆŠè·³æ¿æ©Ÿ | æ–°è·³æ¿æ©Ÿ |
|------|---------|---------|
| ç³»çµ± | Alpine Linux 3.16.9 | Alpine Linux 3.18.12 |
| OpenSSH | 9.0p1-r5 | 9.3p2 |
| é€šé…ç¬¦å•é¡Œ | æœ‰ âœ“ | æœ‰ âœ“ |
| è§£æ±ºæ–¹æ¡ˆ | ä½¿ç”¨å…·é«” IP | ä½¿ç”¨å…·é«” IP |

### æ¨æ¸¬åŸå› 

1. **Alpine Linux ç·¨è­¯æ–¹å¼é™åˆ¶**ï¼šå¯èƒ½ç·¨è­¯æ™‚æœªåŒ…å«å®Œæ•´çš„é€šé…ç¬¦æ”¯æŒåº«
2. **OpenSSH å¯¦ç¾ bug**ï¼šåœ¨æŸäº›é‚Šç•Œæƒ…æ³ä¸‹ï¼Œé€šé…ç¬¦åŒ¹é…é‚è¼¯å¤±æ•ˆ
3. **PermitOpen èªæ³•é™åˆ¶**ï¼šå¯èƒ½æŸäº›ç‰ˆæœ¬çš„ OpenSSH å° `*` å­—å…ƒçš„è§£æä¸å®Œæ•´

---

## è§£æ±ºæ–¹æ¡ˆ

### è¨­è¨ˆåŸå‰‡

åŸºæ–¼æ ¹æœ¬åŸå› åˆ†æï¼Œæœ‰å…©ç¨®å¯èƒ½çš„è§£æ±ºæ–¹æ¡ˆï¼š

| æ–¹æ¡ˆ | å„ªé» | ç¼ºé» | é©ç”¨å ´æ™¯ |
|------|------|------|---------|
| **æ–¹æ¡ˆ Aï¼šå…·é«” IP** | ç°¡å–®ã€å¯é ã€å®‰å…¨ | éœ€æ‰‹å‹•æ·»åŠ æ¯å€‹è¨­å‚™ | âœ… è¨­å‚™æ•¸é‡æœ‰é™ |
| **æ–¹æ¡ˆ Bï¼šä»»ä½• IP** | ç„¡éœ€é…ç½® | å®‰å…¨æ€§æœ€ä½ | âŒ ä¸æ¨è–¦ |

**æ±ºç­–**ï¼šæ¡ç”¨æ–¹æ¡ˆ Aï¼ˆå…·é«” IPï¼‰ï¼Œå› ç‚ºç›®å‰åªéœ€æ”¯æŒ 192.168.100.50

### å¯¦æ–½æ­¥é©Ÿ

#### æ­¥é©Ÿ 1ï¼šæ›´æ–° sshd é…ç½®

ä½¿ç”¨ sed å‘½ä»¤å°‡é€šé…ç¬¦æ›¿æ›ç‚ºå…·é«” IP åœ°å€ï¼š

```bash
ssh -i ~/.ssh/docker-bastion_key -p 2222 root@192.168.213.31 \
  "sed -i 's/^PermitOpen 192.168.100.\*:22/PermitOpen 192.168.100.50:22/' /etc/ssh/sshd_config"
```

**é©—è­‰ä¿®æ”¹**ï¼š
```bash
ssh -i ~/.ssh/docker-bastion_key -p 2222 root@192.168.213.31 \
  'grep PermitOpen /etc/ssh/sshd_config'
```

é æœŸè¼¸å‡ºï¼š
```
PermitOpen 192.168.100.50:22
```

#### æ­¥é©Ÿ 2ï¼šé©—è­‰é…ç½®èªæ³•

åœ¨é‡æ–°è¼‰å…¥å‰ï¼Œç¢ºä¿é…ç½®ç„¡èª¤ï¼š

```bash
ssh -i ~/.ssh/docker-bastion_key -p 2222 root@192.168.213.31 \
  "sshd -t"
```

**æˆåŠŸæ¨™è¨˜**ï¼šç„¡ä»»ä½•è¼¸å‡ºï¼ˆsshd -t åƒ…åœ¨å‡ºéŒ¯æ™‚è¼¸å‡ºï¼‰

#### æ­¥é©Ÿ 3ï¼šé‡æ–°è¼‰å…¥ sshd

é‡æ–°è¼‰å…¥é…ç½®è€Œä¸ä¸­æ–·ç¾æœ‰é€£æ¥ï¼š

```bash
ssh -i ~/.ssh/docker-bastion_key -p 2222 root@192.168.213.31 \
  "pkill -HUP sshd"
```

**æ³¨æ„**ï¼šDocker å®¹å™¨å…§æ²’æœ‰æ¨™æº– pid æ–‡ä»¶ï¼Œä½¿ç”¨ `pkill -HUP` è€Œé `systemctl reload ssh`

### é…ç½®è®Šæ›´è©³æƒ…

**æ–‡ä»¶**ï¼š`/etc/ssh/sshd_config` (Docker å®¹å™¨ bastion-ssh å…§éƒ¨)

**è®Šæ›´å‰**ï¼š
```ini
# Line 85
PermitOpen 192.168.100.*:22
```

**è®Šæ›´å¾Œ**ï¼š
```ini
# Line 85
PermitOpen 192.168.100.50:22
```

**è®Šæ›´é¡å‹**ï¼šé…ç½®èª¿æ•´ï¼ˆéä»£ç¢¼è®Šæ›´ï¼‰

**å½±éŸ¿ç¯„åœ**ï¼š
- SSH è½‰ç™¼è¦å‰‡
- ç›®æ¨™è¨­å‚™ 192.168.100.50 çš„è¨ªå•æ§åˆ¶
- å…¶ä»– IP æ®µçš„è½‰ç™¼èƒ½åŠ›ï¼ˆæš«ç„¡å…¶ä»–éœ€æ±‚ï¼‰

---

## é©—è­‰çµæœ

### é©—è­‰ 1ï¼šæ¸…é™¤ known_hosts è¡çª

ä¿®æ”¹ PermitOpen å¾Œï¼Œæœ¬åœ° known_hosts ä¸­çš„èˆŠ host key å¯èƒ½å°è‡´é©—è­‰å¤±æ•—ï¼Œéœ€æ¸…é™¤ï¼š

```bash
ssh-keygen -f /home/geek/.ssh/known_hosts -R 192.168.100.50
```

**è¼¸å‡º**ï¼š
```
# Host 192.168.100.50 found and removed
```

### é©—è­‰ 2ï¼šAnsible é€£æ¥æ¸¬è©¦

ä½¿ç”¨ Ansible ping æ¨¡çµ„é©—è­‰è·³æ¿æ©Ÿè½‰ç™¼æ˜¯å¦æ­£å¸¸ï¼š

```bash
ansible ISP1 \
  -e 'ansible_ssh_common_args="-o ProxyCommand=\"ssh -W %h:%p -i /home/geek/.ssh/docker-bastion_key -p 2222 root@192.168.213.31\""' \
  -m ping
```

**æ¸¬è©¦çµæœ**ï¼šâœ… **æˆåŠŸ**

```
ISP1 | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
```

**è©³ç´°ä¿¡æ¯**ï¼š
- ISP1 ä¸»æ©Ÿï¼šâœ… é€£æ¥æˆåŠŸ
- è½‰ç™¼ç‹€æ…‹ï¼šâœ… é€šéè·³æ¿æ©Ÿè½‰ç™¼
- æ¨¡çµ„åŸ·è¡Œï¼šâœ… ping æ¨¡çµ„æ­£å¸¸è¿”å›

### é©—è­‰ 3ï¼šç›´æ¥ SSH é€£æ¥æ¸¬è©¦

é©—è­‰æ‰‹å‹• SSH é€£æ¥ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œï¼š

```bash
ssh -o ProxyCommand='ssh -W %h:%p -i /home/geek/.ssh/docker-bastion_key -p 2222 root@192.168.213.31' \
    -i /home/geek/.ssh/cisco_key \
    cisco123@192.168.100.50 \
    'show version | head -1'
```

**é æœŸçµæœ**ï¼šâœ… èƒ½åŸ·è¡Œé ç¨‹å‘½ä»¤ï¼ˆå¦‚æœ Cisco è¨­å‚™å•Ÿç”¨äº†ç‰¹å®šå‘½ä»¤ï¼‰

---

## é…ç½®è®Šæ›´æ‘˜è¦

### ä¿®æ”¹æ¸…å–®

| é …ç›® | è©³æƒ… |
|------|------|
| **ç³»çµ±** | Docker å®¹å™¨ bastion-ssh |
| **ä¸»æ©Ÿåœ°å€** | 192.168.213.31 |
| **å®¹å™¨å…§åœ°å€** | localhost:22 â†’ å®¿ä¸»æ©Ÿ 2222 |
| **ä¿®æ”¹æ–‡ä»¶** | `/etc/ssh/sshd_config` |
| **ä¿®æ”¹è¡Œ** | 85 |
| **ä¿®æ”¹å…§å®¹** | `PermitOpen 192.168.100.*:22` â†’ `PermitOpen 192.168.100.50:22` |
| **æœå‹™é‡è¼‰** | `pkill -HUP sshd` |
| **é©—è­‰æ™‚é–“** | 2026-01-17 |

### é…ç½®å°æ¯”

```diff
--- /etc/ssh/sshd_config (ä¿®æ”¹å‰)
+++ /etc/ssh/sshd_config (ä¿®æ”¹å¾Œ)
@@ -85 +85 @@
-PermitOpen 192.168.100.*:22
+PermitOpen 192.168.100.50:22
```

### æœå‹™æ¢å¾©æ™‚é–“

- **é…ç½®æ›´æ–°è€—æ™‚**ï¼š< 1 ç§’
- **èªæ³•é©—è­‰è€—æ™‚**ï¼š< 1 ç§’
- **æœå‹™é‡è¼‰è€—æ™‚**ï¼š< 1 ç§’
- **è½‰ç™¼æ¢å¾©æ™‚é–“**ï¼šå³æ™‚ï¼ˆç¾æœ‰é€£æ¥æš«æ™‚ä¸­æ–·ï¼Œæ–°é€£æ¥ç«‹å³å¯ç”¨ï¼‰

---

## Docker å®¹å™¨ç‰¹é»

### å®¹å™¨é‹è¡Œä¿¡æ¯

```
å®¹å™¨åç¨±ï¼šbastion-ssh
æ˜ åƒåŸºç¤ï¼šAlpine Linux 3.18.12
SSH ç‰ˆæœ¬ï¼šOpenSSH 9.3p2, OpenSSL 3.1.8
å®¹å™¨å…§ SSHï¼š22
å®¿ä¸»æ©Ÿæ˜ å°„ï¼š2222
èªè­‰æ–¹å¼ï¼šå¯†é‘° (docker-bastion_key)
```

### èˆ‡èˆŠè·³æ¿æ©Ÿçš„å·®ç•°åˆ†æ

| é …ç›® | èˆŠè·³æ¿æ©Ÿ (192.168.213.136:22) | æ–°è·³æ¿æ©Ÿ (192.168.213.31:2222) |
|------|------------------------------|------------------------------|
| **éƒ¨ç½²æ–¹å¼** | å¯¦é«”æ©Ÿæˆ– VM | Docker å®¹å™¨ |
| **ç³»çµ±ç‰ˆæœ¬** | Alpine Linux 3.16.9 | Alpine Linux 3.18.12 |
| **OpenSSH ç‰ˆæœ¬** | 9.0p1-r5 | 9.3p2 |
| **OpenSSL ç‰ˆæœ¬** | 3.0.x | 3.1.8 |
| **PermitOpen æ”¯æŒ** | é€šé…ç¬¦ä¸å·¥ä½œ âœ— | é€šé…ç¬¦ä¸å·¥ä½œ âœ— |
| **è§£æ±ºæ–¹æ¡ˆ** | ä½¿ç”¨å…·é«” IP | ä½¿ç”¨å…·é«” IP |
| **ä¸»è¦å„ªé»** | ç©©å®šé‹è¡Œ | å®¹å™¨åŒ–ï¼Œæ˜“æ–¼ç¶­è­· |

### å®¹å™¨å„ªå‹¢

1. **å¿«é€Ÿéƒ¨ç½²**ï¼šç„¡éœ€ç‰©ç†æ©Ÿï¼Œç§’ç´šå•Ÿå‹•
2. **æ˜“æ–¼ç¶­è­·**ï¼šé…ç½®å’Œæ‡‰ç”¨æ‰“åŒ…åœ¨æ˜ åƒä¸­
3. **å®‰å…¨éš”é›¢**ï¼šå®¹å™¨å…§çš„æœå‹™èˆ‡å®¿ä¸»æ©Ÿéš”é›¢
4. **ç‰ˆæœ¬ç®¡ç†**ï¼šæ˜ åƒç‰ˆæœ¬åŒ–ä¾¿æ–¼è¿½è¹¤

### å®¹å™¨é™åˆ¶

1. **sshd é‡è¼‰æ–¹å¼**ï¼šéœ€ä½¿ç”¨ `pkill -HUP` è€Œéç³»çµ±æœå‹™å‘½ä»¤
2. **pid æ–‡ä»¶ç¼ºå¤±**ï¼šæŸäº›ç®¡ç†å·¥å…·ä¸å¯ç”¨
3. **æ—¥èªŒä½ç½®**ï¼šéœ€æª¢æŸ¥å®¹å™¨æ—¥èªŒè€Œéç³»çµ±æ—¥èªŒ

---

## å®‰å…¨æ€§è€ƒé‡

### ä¿®æ”¹é¢¨éšªè©•ä¼°

| é¢¨éšªé … | è©•ä¼° | èªªæ˜ |
|--------|------|------|
| **é…ç½®èªæ³•** | ğŸŸ¢ ä½ | sshd -t é©—è­‰é€šé |
| **é€£æ¥ä¸­æ–·** | ğŸŸ¡ ä¸­ | pkill -HUP æœƒæš«æ™‚ä¸­æ–·ï¼Œä½†ç«‹å³æ¢å¾© |
| **æœå‹™å¯ç”¨æ€§** | ğŸŸ¢ ä½ | è½‰ç™¼è¦å‰‡è®Šæ›´ä¸å½±éŸ¿ç™»éŒ„åŠŸèƒ½ |
| **å®‰å…¨æ€§å¢å¼·** | ğŸŸ¢ æ­£å‘ | å¾å¯¬é¬†çš„é€šé…ç¬¦æ”¹ç‚ºå…·é«” IP æ›´å®‰å…¨ |

### å®‰å…¨æ€§æ”¹é€²

ä¿®æ”¹å¯¦éš›ä¸Š**æå‡äº†**ç³»çµ±çš„å®‰å…¨æ€§ï¼š

1. **è¨ªå•æ§åˆ¶æ›´ç²¾ç¢º**
   - ä¿®æ”¹å‰ï¼šå…è¨±è½‰ç™¼åˆ°æ•´å€‹ `192.168.100.0/24` ç¶²æ®µ
   - ä¿®æ”¹å¾Œï¼šåƒ…å…è¨±è½‰ç™¼åˆ° `192.168.100.50`

2. **ç¬¦åˆæœ€å°æ¬Šé™åŸå‰‡**
   - åªé–‹æ”¾å¿…è¦çš„è½‰ç™¼è¦å‰‡
   - æ‹’çµ•æœªæˆæ¬Šçš„å…¶ä»–è¨­å‚™è¨ªå•

3. **é˜²æ­¢æ„å¤–è½‰ç™¼**
   - é˜²æ­¢èª¤é…ç½®æˆ–èˆŠå¯†é‘°è¢«ç”¨æ–¼è¨ªå•å…¶ä»–è¨­å‚™
   - é™ä½æ©«å‘ç§»å‹•é¢¨éšª

### æœªä¾†æ“´å±•è€ƒé‡

å¦‚æœéœ€è¦æ”¯æŒæ›´å¤šç›®æ¨™è¨­å‚™ï¼Œå¯æ·»åŠ å¤šå€‹ PermitOpen è¡Œï¼š

```ini
PermitOpen 192.168.100.50:22
PermitOpen 192.168.100.51:22
PermitOpen 192.168.100.52:22
```

---

## æ•…éšœæ’é™¤æµç¨‹ç¸½çµ

### è¨ºæ–·æµç¨‹åœ–

```
å•é¡Œï¼šç„¡æ³•è½‰ç™¼åˆ° 192.168.100.50
  â†“
[ç¬¬ 1 æ­¥] æª¢æŸ¥ sshd é…ç½®
  â†’ AllowTcpForwarding: yes âœ“
  â†’ PermitOpen: 192.168.100.*:22 (å¯ç–‘)
  â†“
[ç¬¬ 2 æ­¥] æ¸¬è©¦ç¶²è·¯é€£é€šæ€§
  â†’ ping æˆåŠŸ âœ“
  â†’ æ’é™¤ç¶²è·¯å±¤é¢å•é¡Œ
  â†“
[ç¬¬ 3 æ­¥] ç¢ºèªè»Ÿé«”ç‰ˆæœ¬
  â†’ OpenSSH 9.3p2 (æ‡‰æ”¯æŒé€šé…ç¬¦)
  â†“
[ç¬¬ 4 æ­¥] æ¸¬è©¦ SSH è½‰ç™¼
  â†’ è·³æ¿æ©Ÿèªè­‰é€šé âœ“
  â†’ è½‰ç™¼è«‹æ±‚è¢« sshd æ‹’çµ• âœ—
  â†“
[çµè«–] PermitOpen é€šé…ç¬¦ä¸å·¥ä½œ
  â†“
[ä¿®å¾©] æ›¿æ›ç‚ºå…·é«” IP: 192.168.100.50:22
  â†“
[é©—è­‰] Ansible ping å’Œ SSH é€£æ¥æˆåŠŸ âœ“
```

### å¿«é€Ÿæ•…éšœæ’é™¤æª¢æŸ¥æ¸…å–®

å¦‚æœæœªä¾†é‡åˆ°é¡ä¼¼å•é¡Œï¼Œå¯æŒ‰ä»¥ä¸‹é †åºæ’æŸ¥ï¼š

- [ ] **ç¬¬ 1 æ­¥**ï¼šæª¢æŸ¥ç¶²è·¯é€£é€šæ€§ï¼ˆpingï¼‰
  ```bash
  ssh -p 2222 root@192.168.213.31 'ping -c 2 <ç›®æ¨™IP>'
  ```

- [ ] **ç¬¬ 2 æ­¥**ï¼šæª¢æŸ¥ sshd é…ç½®
  ```bash
  ssh -p 2222 root@192.168.213.31 'cat /etc/ssh/sshd_config | grep -E "AllowTcp|PermitOpen"'
  ```

- [ ] **ç¬¬ 3 æ­¥**ï¼šé©—è­‰ PermitOpen èªæ³•
  ```bash
  ssh -p 2222 root@192.168.213.31 'sshd -t'
  ```

- [ ] **ç¬¬ 4 æ­¥**ï¼šæ¸¬è©¦ ProxyCommand è½‰ç™¼
  ```bash
  ssh -o ProxyCommand='ssh -W %h:%p -p 2222 root@192.168.213.31' -v <ç”¨æˆ¶>@<ç›®æ¨™IP>
  ```

- [ ] **ç¬¬ 5 æ­¥**ï¼šå¦‚è½‰ç™¼å¤±æ•—ï¼Œæª¢æŸ¥ PermitOpen æ˜¯å¦ä½¿ç”¨é€šé…ç¬¦
  - å¦‚æ˜¯ï¼šæ”¹ç‚ºå…·é«” IP
  - ç¢ºèª sshd -t ç„¡èª¤
  - åŸ·è¡Œ pkill -HUP sshd é‡è¼‰

---

## ç¶“é©—æ•™è¨“

### ç¶“é©— 1ï¼šOpenSSH 9.x ç‰ˆæœ¬çš„å·²çŸ¥é™åˆ¶

**æ•™è¨“**ï¼šAlpine Linux ä¸Šçš„ OpenSSH 9.0+ ç‰ˆæœ¬å° PermitOpen é€šé…ç¬¦çš„æ”¯æŒå­˜åœ¨ç¼ºé™·ã€‚

**é©ç”¨ç‰ˆæœ¬**ï¼š
- OpenSSH 9.0p1-r5ï¼ˆèˆŠè·³æ¿æ©Ÿï¼‰
- OpenSSH 9.3p2ï¼ˆæ–°è·³æ¿æ©Ÿï¼‰

**è¦é¿æ–¹æ³•**ï¼š
- é¿å…ä½¿ç”¨ `*` é€šé…ç¬¦
- ä½¿ç”¨å…·é«” IP åœ°å€åˆ—è¡¨
- å¿…è¦æ™‚è€ƒæ…®å‡ç´šåˆ° 10.x ç‰ˆæœ¬ï¼ˆéœ€æ¸¬è©¦ï¼‰

**åƒè€ƒ**ï¼š
- èˆŠè·³æ¿æ©ŸåŒé¡å•é¡Œå ±å‘Šï¼š`2026-01-17-permitopen-wildcard-issue.md`

### ç¶“é©— 2ï¼šDocker å®¹å™¨çš„ sshd é‡è¼‰

**æ•™è¨“**ï¼šDocker å®¹å™¨å…§çš„ sshd æ²’æœ‰æ¨™æº–çš„ pid æ–‡ä»¶å’Œç³»çµ±æœå‹™ç®¡ç†ã€‚

**æ­£ç¢ºæ–¹æ³•**ï¼š
```bash
pkill -HUP sshd  # ç™¼é€ SIGHUP ä¿¡è™Ÿé‡è¼‰é…ç½®
```

**éŒ¯èª¤æ–¹æ³•**ï¼š
```bash
systemctl reload ssh      # âŒ å®¹å™¨å…§å¯èƒ½ç„¡ systemd
/etc/init.d/sshd reload   # âŒ å®¹å™¨å…§å¯èƒ½ç„¡ init.d
```

**ç‰¹é»**ï¼š
- `pkill -HUP` æœƒæš«æ™‚ä¸­æ–·ç¾æœ‰é€£æ¥
- æœå‹™ç«‹å³é‡è¼‰æ–°é…ç½®ï¼Œç„¡åœæ©Ÿæ™‚é–“
- æ–°é€£æ¥å¯ç”¨æ™‚é–“ < 1 ç§’

### ç¶“é©— 3ï¼šknown_hosts è¡çªè™•ç†

**æ•™è¨£**ï¼šåˆ‡æ›è·³æ¿æ©Ÿæˆ–ä¿®æ”¹ç›®æ¨™è¨­å‚™ IP æ™‚ï¼Œéœ€æ¸…é™¤æœ¬åœ° known_hostsã€‚

**ç—‡ç‹€**ï¼š
```
Host key verification failed
or
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
```

**è§£æ±º**ï¼š
```bash
ssh-keygen -f ~/.ssh/known_hosts -R <IPåœ°å€>
```

**æœ€ä½³å¯¦è¸**ï¼š
- ç¬¬ä¸€æ¬¡é€£æ¥æ–°è¨­å‚™æ™‚ï¼Œç¢ºèª host key æŒ‡ç´‹
- ä½¿ç”¨ Ansible æ™‚é…ç½® `host_key_checking: false`ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
- æˆ–åœ¨ ansible.cfg ä¸­è¨­ç½® `[defaults] host_key_checking = False`

### ç¶“é©— 4ï¼šAlpine Linux å®¹å™¨çš„èª¿è©¦

**æ•™è¨£**ï¼šAlpine å®¹å™¨å…§çš„å·¥å…·é›†ç²¾ç°¡ï¼ŒæŸäº›èª¿è©¦å·¥å…·ç¼ºå¤±ã€‚

**å¸¸è¦‹ç¼ºå¤±**ï¼š
- `netstat`ï¼ˆä½¿ç”¨ `ss` æ›¿ä»£ï¼‰
- `ifconfig`ï¼ˆä½¿ç”¨ `ip` æ›¿ä»£ï¼‰
- `ps aux`ï¼ˆç”¨æ³•ç›¸åŒä½†è¼¸å‡ºæ ¼å¼ä¸åŒï¼‰

**èª¿è©¦å»ºè­°**ï¼š
- ä½¿ç”¨ Docker çš„ `docker exec -it` é€²å…¥å®¹å™¨
- ä½¿ç”¨ `docker logs` æŸ¥çœ‹å®¹å™¨æ—¥èªŒ
- å¿…è¦æ™‚åœ¨å®¹å™¨æ˜ åƒä¸­é è£å¸¸ç”¨å·¥å…·

---

## å¾ŒçºŒå»ºè­°

### çŸ­æœŸè¡Œå‹•ï¼ˆå·²å®Œæˆï¼‰

- âœ… **å·²æ‡‰ç”¨ä¿®å¾©æ–¹æ¡ˆ**
  - æ›´æ–° PermitOpen é…ç½®ç‚ºå…·é«” IP
  - é‡è¼‰ sshd é…ç½®
  - é©—è­‰è½‰ç™¼åŠŸèƒ½æ­£å¸¸

### ä¸­æœŸè¡Œå‹•ï¼ˆ1-2 å‘¨å…§ï¼‰

- [ ] **Ansible inventory æ›´æ–°**
  - åœ¨ `group_vars` æˆ– `host_vars` ä¸­é…ç½®ä»£ç†è·³è½‰
  - ä½¿ç”¨æ–°è·³æ¿æ©Ÿ (192.168.213.31:2222) è€ŒéèˆŠè·³æ¿æ©Ÿ
  - æ¸¬è©¦æ‰€æœ‰ ISP ä¸»æ©Ÿçš„é€£é€šæ€§

- [ ] **æ–‡æª”æ›´æ–°**
  - æ›´æ–°ç¶²è·¯æ‹“æ’²æ–‡æª”
  - æ›´æ–° SSH é…ç½®æŒ‡å—
  - è¨˜éŒ„ OpenSSH é€šé…ç¬¦å•é¡Œ

- [ ] **èˆŠè·³æ¿æ©Ÿç®¡ç†**
  - æ±ºå®šæ˜¯å¦ä¿ç•™èˆŠè·³æ¿æ©Ÿä½œç‚ºå‚™ä»½
  - å¦‚ä¸éœ€è¦ï¼Œè¦åŠƒä¸‹ç·šæµç¨‹

### é•·æœŸè¡Œå‹•ï¼ˆ1 å€‹æœˆä»¥ä¸Šï¼‰

- [ ] **OpenSSH ç‰ˆæœ¬å‡ç´šè©•ä¼°**
  - æ¸¬è©¦ OpenSSH 10.x æ˜¯å¦è§£æ±ºé€šé…ç¬¦å•é¡Œ
  - è©•ä¼°å‡ç´šçš„å®‰å…¨æ€§å’Œå…¼å®¹æ€§
  - åˆ¶å®šå‡ç´šè¨ˆç•«

- [ ] **è·³æ¿æ©Ÿæ¶æ§‹å„ªåŒ–**
  - è€ƒæ…®ä½¿ç”¨å°ˆæ¥­çš„å ¡å£˜æ©Ÿç”¢å“ï¼ˆå¦‚ Teleportã€Telecomï¼‰
  - è©•ä¼°å¤šè·³æ¿æ©Ÿçš„è² è¼‰å‡è¡¡
  - å¯¦æ–½æ›´ç´°ç²’åº¦çš„è¨ªå•æ§åˆ¶

- [ ] **è‡ªå‹•åŒ–å¢å¼·**
  - è‡ªå‹•åŒ–æ–°ç›®æ¨™è¨­å‚™çš„ PermitOpen é…ç½®æ·»åŠ 
  - å¯¦æ–½è®Šæ›´è¿½è¹¤å’Œå¯©è¨ˆ
  - æ§‹å»ºè·³æ¿æ©Ÿé…ç½®ç®¡ç†ç³»çµ±

### æ‡‰æ€¥éŸ¿æ‡‰æ–¹æ¡ˆ

å¦‚æœè·³æ¿æ©Ÿæœå‹™ä¸­æ–·ï¼Œå‚™é¸æ–¹æ¡ˆï¼š

1. **ä½¿ç”¨èˆŠè·³æ¿æ©Ÿ**ï¼ˆå¦‚ä»åœ¨é‹è¡Œï¼‰
   - åœ°å€ï¼š192.168.213.136:22
   - å¯†é‘°ï¼šåŒä¸Š
   - é…ç½®ï¼šå·²çŸ¥å¯æ­£å¸¸å·¥ä½œ

2. **ç›´æ¥é€£æ¥**ï¼ˆåƒ…ç”¨æ–¼ç·Šæ€¥èª¿è©¦ï¼‰
   - è¦æ±‚è‡¨æ™‚é–‹æ”¾é˜²ç«ç‰†è¦å‰‡
   - æé«˜å®‰å…¨é¢¨éšªï¼Œåƒ…çŸ­æœŸä½¿ç”¨

3. **VPN é€£æ¥**ï¼ˆå¦‚å·²é…ç½®ï¼‰
   - ä½¿ç”¨ VPN é€£æ¥åˆ°å…§ç¶²
   - ç¹éè·³æ¿æ©Ÿç›´æ¥é€£æ¥è¨­å‚™

---

## ç›¸é—œæ–‡ä»¶å’Œåƒè€ƒ

### æœ¬é …ç›®æ–‡ä»¶

- **æœ¬å ±å‘Š**ï¼š`/docker-bastion-ssh/docs/troubleshooting/2026-01-17-docker-bastion-permitopen-fix.md`
- **å®¹å™¨é…ç½®**ï¼š`/docker-bastion-ssh/` (Dockerfile, docker-compose.yml ç­‰)

### ç›¸é—œå ±å‘Š

- **èˆŠè·³æ¿æ©ŸåŒé¡å•é¡Œ**ï¼š`/ansible_network-lab/docs/troubleshooting/2026-01-17-permitopen-wildcard-issue.md`
  - è¨˜éŒ„äº† OpenSSH 9.0p1 çš„ç›¸åŒå•é¡Œ
  - åŒ…å«å•é¡ŒèƒŒæ™¯å’Œåˆå§‹è¨ºæ–·

### ç³»çµ±æ–‡æª”

- OpenSSH sshd_config æ‰‹å†Šï¼š`man sshd_config`
- Alpine Linux Docker æ˜ åƒï¼š`https://hub.docker.com/_/alpine`
- OpenSSH 9.3p2 ç™¼ä½ˆèªªæ˜

### å‘½ä»¤åƒè€ƒ

**æŸ¥çœ‹ sshd é…ç½®**ï¼š
```bash
ssh -p 2222 root@192.168.213.31 'cat /etc/ssh/sshd_config'
```

**æ¸¬è©¦è½‰ç™¼é€£æ¥**ï¼š
```bash
ssh -o ProxyCommand='ssh -W %h:%p -p 2222 root@192.168.213.31' <ç”¨æˆ¶>@192.168.100.50
```

**ä½¿ç”¨ Ansible æ¸¬è©¦**ï¼š
```bash
ansible all -i hosts.ini -e 'ansible_ssh_common_args="-o ProxyCommand=..."' -m ping
```

---

## é™„éŒ„

### A. å®Œæ•´çš„ sshd é…ç½®ç‰‡æ®µ

**ä¿®æ”¹å‰**ï¼ˆå®¹å™¨å•Ÿå‹•æ™‚ï¼‰ï¼š
```ini
Port 22
AddressFamily any
ListenAddress 0.0.0.0
ListenAddress ::

PermitRootLogin yes
StrictModes no

AllowTcpForwarding yes
PermitOpen 192.168.100.*:22
GatewayPorts no

PasswordAuthentication yes
PubkeyAuthentication yes

LogLevel INFO
```

**ä¿®æ”¹å¾Œ**ï¼ˆç•¶å‰é…ç½®ï¼‰ï¼š
```ini
Port 22
AddressFamily any
ListenAddress 0.0.0.0
ListenAddress ::

PermitRootLogin yes
StrictModes no

AllowTcpForwarding yes
PermitOpen 192.168.100.50:22
GatewayPorts no

PasswordAuthentication yes
PubkeyAuthentication yes

LogLevel INFO
```

### B. Ansible é…ç½®ç¤ºä¾‹

**hosts.ini é…ç½®**ï¼š
```ini
[ISP]
ISP1 ansible_host=192.168.100.50 ansible_user=cisco123

[ISP:vars]
ansible_ssh_common_args=-o ProxyCommand="ssh -W %h:%p -i /home/geek/.ssh/docker-bastion_key -p 2222 root@192.168.213.31"
```

**é‹è¡Œ playbook**ï¼š
```bash
ansible-playbook -i hosts.ini site.yml
```

### C. æ•…éšœæ’é™¤æ—¥èªŒ

**å®Œæ•´è¨ºæ–·åŸ·è¡Œæ—¥èªŒ**ï¼š

```
[2026-01-17 10:30] é–‹å§‹è¨ºæ–· Docker è·³æ¿æ©Ÿè½‰ç™¼å•é¡Œ
[2026-01-17 10:31] æª¢æŸ¥ sshd é…ç½®... PermitOpen: 192.168.100.*:22
[2026-01-17 10:32] æ¸¬è©¦ç¶²è·¯é€£é€šæ€§... ping æˆåŠŸ
[2026-01-17 10:33] ç¢ºèªè»Ÿé«”ç‰ˆæœ¬... OpenSSH 9.3p2
[2026-01-17 10:34] æ¸¬è©¦ SSH è½‰ç™¼... è½‰ç™¼è¢«æ‹’çµ•
[2026-01-17 10:35] åˆ†æ: PermitOpen é€šé…ç¬¦ä¸å·¥ä½œ
[2026-01-17 10:36] æ‡‰ç”¨ä¿®å¾©: ä½¿ç”¨å…·é«” IP 192.168.100.50:22
[2026-01-17 10:37] é©—è­‰é…ç½®èªæ³•... OK
[2026-01-17 10:38] é‡è¼‰ sshd é…ç½®... OK
[2026-01-17 10:39] æ¸¬è©¦ Ansible ping... SUCCESS
[2026-01-17 10:40] è¨ºæ–·å®Œæˆï¼Œå•é¡Œè§£æ±º
```

### D. Docker å®¹å™¨æª¢æŸ¥å‘½ä»¤

**æª¢æŸ¥å®¹å™¨ç‹€æ…‹**ï¼š
```bash
docker ps | grep bastion-ssh
```

**æŸ¥çœ‹å®¹å™¨æ—¥èªŒ**ï¼š
```bash
docker logs bastion-ssh | tail -20
```

**é€²å…¥å®¹å™¨èª¿è©¦**ï¼š
```bash
docker exec -it bastion-ssh sh
```

**æª¢æŸ¥å®¹å™¨å…§ sshd é…ç½®**ï¼š
```bash
docker exec bastion-ssh cat /etc/ssh/sshd_config
```

---

**å ±å‘Šå®Œæˆæ—¥æœŸ**ï¼š2026-01-17
**é©—è­‰ç‹€æ…‹**ï¼šâœ… å·²é©—è­‰å’Œæ¸¬è©¦
**å»ºè­°ç‹€æ…‹**ï¼šå·²æŒ‰æ¨™æº–åŸ·è¡Œ

