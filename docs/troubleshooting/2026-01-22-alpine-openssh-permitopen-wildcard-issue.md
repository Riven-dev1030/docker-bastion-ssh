# Alpine Linux ä¸Š OpenSSH PermitOpen é€šé…ç¬¦åŠŸèƒ½ç¼ºé™·åˆ†æ

**å ±å‘Šæ—¥æœŸ**ï¼š2026-01-22
**åˆ†æå°è±¡**ï¼šAlpine Linux OpenSSH PermitOpen é€šé…ç¬¦ä¸å·¥ä½œå•é¡Œ
**å—å½±éŸ¿ç‰ˆæœ¬**ï¼šAlpine Linux 3.16.9 + OpenSSH 9.0p1-r5ã€Alpine Linux 3.18.12 + OpenSSH 9.3p2
**å—å½±éŸ¿ç³»çµ±**ï¼šèˆŠè·³æ¿æ©Ÿ (192.168.213.136:22)ã€æ–°è·³æ¿æ©Ÿ (192.168.213.31:2222)
**å ±å‘Šç‹€æ…‹**ï¼šâœ… å·²é©—è­‰å’Œåˆ†æ

---

## åŸ·è¡Œæ‘˜è¦

### å•é¡Œç°¡è¿°

Alpine Linux ä¸Šçš„ OpenSSHï¼ˆ9.0p1-r5 å’Œ 9.3p2 ç‰ˆæœ¬ï¼‰å° `PermitOpen` é…ç½®æŒ‡ä»¤ä¸­çš„é€šé…ç¬¦ï¼ˆ`*`ï¼‰æ”¯æŒå­˜åœ¨åš´é‡ç¼ºé™·ã€‚å„˜ç®¡å®˜æ–¹æ–‡æª”æ˜ç¢ºè²ç¨±æ”¯æ´é€šé…ç¬¦å’Œ CIDR è¡¨ç¤ºæ³•ï¼Œä½†åœ¨å¯¦éš›ç’°å¢ƒä¸­ç„¡æ³•æ­£ç¢ºåŒ¹é… IP åœ°å€ã€‚

### å—å½±éŸ¿ç¯„åœ

| ç’°å¢ƒ | ç³»çµ± | OpenSSH | é€šé…ç¬¦æ”¯æŒ | å½±éŸ¿ç¨‹åº¦ |
|------|------|---------|-----------|---------|
| èˆŠè·³æ¿æ©Ÿ | Alpine Linux 3.16.9 | 9.0p1-r5 | âœ— ä¸å·¥ä½œ | ğŸ”´ ç”Ÿç”¢å½±éŸ¿ |
| æ–°è·³æ¿æ©Ÿ (Docker) | Alpine Linux 3.18.12 | 9.3p2 | âœ— ä¸å·¥ä½œ | ğŸ”´ ç”Ÿç”¢å½±éŸ¿ |

### æ ¹æœ¬åŸå› 

è©²å•é¡Œ**ä¸æ˜¯å–®ç´”çš„ç‰ˆæœ¬ç¼ºé™·**ï¼Œè€Œæ˜¯ **Alpine Linux ç·¨è­¯å’Œæ‰“åŒ…æ–¹å¼çš„å•é¡Œ**ï¼Œå¯èƒ½æ¶‰åŠï¼š

1. **ç·¨è­¯é…ç½®ç¼ºé™·**ï¼šOpenSSH åœ¨ Alpine ä¸Šç·¨è­¯æ™‚ï¼Œé€šé…ç¬¦åŒ¹é…ç›¸é—œçš„ä»£ç¢¼å¯èƒ½è¢«è·³éæˆ–æå£
2. **musl libc ç›¸å®¹æ€§**ï¼šAlpine ä½¿ç”¨ musl libc è€Œé glibcï¼ŒæŸäº›ç³»çµ±å‡½æ•¸è¡Œç‚ºå¯èƒ½ä¸åŒ
3. **ä¾è³´åº«ç¼ºå¤±**ï¼šå¯¦ç¾é€šé…ç¬¦åŒ¹é…çš„ä¾è³´åº«å¯èƒ½åœ¨ Alpine ä¸Šç¼ºå¤±æˆ–ç‰ˆæœ¬ä¸ç›¸å®¹

### è§£æ±ºæ–¹æ¡ˆ

**çŸ­æœŸ**ï¼ˆå·²é©—è­‰ï¼‰ï¼š
- å°‡ `PermitOpen 192.168.100.*:22` æ›¿æ›ç‚º `PermitOpen 192.168.100.50:22`ï¼ˆå…·é«” IPï¼‰
- éœ€è¦æ”¯æŒå¤šå€‹ IP æ™‚ï¼Œæ·»åŠ å¤šæ¢ PermitOpen è¡Œ

**ä¸­æœŸ**ï¼ˆå¾…é©—è­‰ï¼‰ï¼š
- åˆ‡æ›åˆ°å…¶ä»–åŸºç¤é¡åƒï¼ˆå¦‚ Debianã€Ubuntuï¼‰
- æ¸¬è©¦ OpenSSH 10.x ç‰ˆæœ¬ï¼ˆå¦‚å¯ç”¨ï¼‰

**é•·æœŸ**ï¼š
- å‘ Alpine ç¤¾ç¾¤æäº¤å•é¡Œå ±å‘Š
- ç­‰å¾…å®˜æ–¹ä¿®å¾©ç™¼ä½ˆ

---

## å•é¡ŒèƒŒæ™¯

### ä»€éº¼æ˜¯ PermitOpen

`PermitOpen` æ˜¯ OpenSSH æœå‹™å™¨ (`sshd`) çš„ä¸€å€‹é…ç½®æŒ‡ä»¤ï¼Œç”¨æ–¼é™åˆ¶ç‰¹å®šå…¬é‘°å¯ä»¥è½‰ç™¼é€£æ¥åˆ°çš„ç›®æ¨™åœ°å€å’Œç«¯å£ã€‚

**å®˜æ–¹å®šç¾©** (OpenSSH 9.3 man æ‰‹å†Š):

```
PermitOpen pattern [pattern ...]
    Specifies the destinations to which TCP port forwarding is permitted.
    The forwarding specification must be one of:

    "any" to allow forwarding to any host and port
    a pattern consisting of zero or more "*" characters or one
     or more digits matching a host or network, and a port to
     allow forwarding to that host or port.  IPv6 addresses can
     be specified by enclosing the address in square brackets.
     An example pattern is "192.168.1.0/24 8000-9000".

    By default, all port forwarding requests are permitted.
```

**å…¸å‹ç”¨æ³•**ï¼š

```bash
# åªå…è¨±è½‰ç™¼åˆ° 192.168.100.50 çš„ 22 ç«¯å£
PermitOpen 192.168.100.50:22

# åªå…è¨±è½‰ç™¼åˆ°æ•´å€‹ 192.168.100.0/24 ç¶²æ®µçš„ 22 ç«¯å£
PermitOpen 192.168.100.0/24:22

# åªå…è¨±è½‰ç™¼åˆ° 192.168.100.x çš„ 22 ç«¯å£ï¼ˆä½¿ç”¨é€šé…ç¬¦ï¼‰
PermitOpen 192.168.100.*:22

# å…è¨±å¤šå€‹ç›®æ¨™
PermitOpen 192.168.100.50:22
PermitOpen 192.168.101.10:22

# å…è¨±ç¯„åœç«¯å£
PermitOpen 192.168.100.50:8000-9000
```

### é€šé…ç¬¦çš„é æœŸè¡Œç‚º

æ ¹æ“š OpenSSH å®˜æ–¹æ–‡æª”ï¼Œ`PermitOpen` æ”¯æŒä»¥ä¸‹åŒ¹é…æ–¹å¼ï¼š

| æ¨¡å¼ | å«ç¾© | ç¤ºä¾‹ | é æœŸçµæœ |
|------|------|------|---------|
| å®Œæ•´ IP + ç«¯å£ | ç²¾ç¢ºåŒ¹é… | `192.168.100.50:22` | åƒ…å…è¨± 192.168.100.50:22 |
| é€šé…ç¬¦æ¨¡å¼ | æ¨¡ç³ŠåŒ¹é… | `192.168.100.*:22` | å…è¨± 192.168.100.0-255:22 |
| CIDR ç¶²æ®µ | ç¶²æ®µåŒ¹é… | `192.168.100.0/24:22` | å…è¨± 192.168.100.0-255:22 |
| ç«¯å£ç¯„åœ | ç«¯å£å€é–“ | `192.168.100.50:8000-9000` | å…è¨± 192.168.100.50:8000-9000 |
| ä»»æ„ | ç„¡é™åˆ¶ | `any` | å…è¨±ä»»ä½•ç›®æ¨™ |

**é—œéµé æœŸ**ï¼š
- é€šé…ç¬¦ `*` æ‡‰åŒ¹é…è©²ä½ç½®çš„ä»»æ„ä¸€å€‹æˆ–å¤šå€‹æ•¸å­—ï¼ˆ0-9ï¼‰
- æ¨¡å¼ `192.168.100.*:22` æ‡‰ç­‰æ•ˆæ–¼ `192.168.100.0/24:22`
- é€£æ¥è«‹æ±‚æ‡‰å°ç…§æ¨¡å¼é€²è¡ŒåŒ¹é…ï¼ŒåŒ¹é…å‰‡å…è¨±ï¼Œä¸åŒ¹é…å‰‡æ‹’çµ•

### å®˜æ–¹æ–‡æª”èªªæ˜

**OpenSSH 9.3p2 æ‰‹å†Šæ‘˜éŒ„**ï¼ˆ`man sshd_config`ï¼‰ï¼š

```
PermitOpen pattern [pattern ...]
    Specifies the destinations to which TCP port forwarding is permitted.
    The forwarding specification must be one of:

    "any" to allow forwarding to any host and port
    a pattern consisting of zero or more "*" characters or one
     or more digits matching a host or network, and a port to
     allow forwarding to that host or port.
```

**é—œéµè²æ˜**ï¼š
1. âœ… é€šé…ç¬¦ `*` æ‡‰è¢«æ”¯æŒ
2. âœ… CIDR è¨˜è™Ÿæ‡‰è¢«æ”¯æŒï¼ˆå¦‚ 192.168.100.0/24ï¼‰
3. âœ… ç«¯å£ç¯„åœæ‡‰è¢«æ”¯æŒ
4. æ–‡æª”æœªæåŠä»»ä½•å·²çŸ¥é™åˆ¶æˆ–å¹³å°å·®ç•°

---

## å—å½±éŸ¿ç’°å¢ƒ

### ç’°å¢ƒ 1ï¼šèˆŠè·³æ¿æ©Ÿ

**ç³»çµ±é…ç½®**ï¼š
```
ä¸»æ©Ÿåœ°å€ï¼š192.168.213.136
SSH ç«¯å£ï¼š22
ç³»çµ±ï¼šAlpine Linux 3.16.9
OpenSSH ç‰ˆæœ¬ï¼š9.0p1-r5
OpenSSL ç‰ˆæœ¬ï¼š3.0.x
éƒ¨ç½²æ–¹å¼ï¼šå¯¦é«”æ©Ÿæˆ– VM
```

**PermitOpen é…ç½®**ï¼š
```ini
PermitOpen 192.168.100.*:22
```

**è§€å¯Ÿåˆ°çš„å•é¡Œ**ï¼š
- âŒ è½‰ç™¼åˆ° 192.168.100.50 è¢«æ‹’çµ•
- âœ… æ›¿æ›ç‚º `PermitOpen 192.168.100.50:22` å¾Œå·¥ä½œæ­£å¸¸

**åƒè€ƒå ±å‘Š**ï¼š
- `2026-01-17-permitopen-wildcard-issue.md`ï¼ˆèˆŠç³»çµ±å ±å‘Šï¼‰

### ç’°å¢ƒ 2ï¼šæ–°è·³æ¿æ©Ÿ (Docker)

**ç³»çµ±é…ç½®**ï¼š
```
ä¸»æ©Ÿåœ°å€ï¼š192.168.213.31
SSH ç«¯å£ï¼š2222ï¼ˆDocker æ˜ å°„ï¼‰
å®¹å™¨åç¨±ï¼šbastion-ssh
ç³»çµ±ï¼šAlpine Linux 3.18.12
OpenSSH ç‰ˆæœ¬ï¼š9.3p2
OpenSSL ç‰ˆæœ¬ï¼š3.1.8
éƒ¨ç½²æ–¹å¼ï¼šDocker å®¹å™¨
```

**PermitOpen é…ç½®**ï¼ˆä¿®æ”¹å‰ï¼‰ï¼š
```ini
PermitOpen 192.168.100.*:22
```

**è§€å¯Ÿåˆ°çš„å•é¡Œ**ï¼š
- âŒ è½‰ç™¼åˆ° 192.168.100.50 è¢«æ‹’çµ•
- âœ… æ›¿æ›ç‚º `PermitOpen 192.168.100.50:22` å¾Œå·¥ä½œæ­£å¸¸

**åƒè€ƒå ±å‘Š**ï¼š
- `2026-01-17-docker-bastion-permitopen-fix.md`ï¼ˆæ–°ç³»çµ±ä¿®å¾©å ±å‘Šï¼‰

---

## æŠ€è¡“åˆ†æ

### ç™¼ç¾ 1ï¼šå•é¡Œä¸æ˜¯å–®ç´”çš„ç‰ˆæœ¬ç¼ºé™·

**è­‰æ“šéˆ**ï¼š

| ç‰ˆæœ¬çµ„åˆ | ç³»çµ± | é€šé…ç¬¦æ”¯æŒ | çµè«– |
|---------|------|-----------|------|
| OpenSSH 9.0p1-r5 + Alpine 3.16.9 | èˆŠè·³æ¿æ©Ÿ | âœ— | ç‰ˆæœ¬ 9.0 æœ‰å•é¡Œ |
| OpenSSH 9.3p2 + Alpine 3.18.12 | æ–°è·³æ¿æ©Ÿ | âœ— | ç‰ˆæœ¬ 9.3 æœ‰ç›¸åŒå•é¡Œ |
| **å‡ç´š OpenSSH** | 9.0 â†’ 9.3 | âœ— | å‡ç´šæœªè§£æ±º |
| **å‡ç´š Alpine** | 3.16 â†’ 3.18 | âœ— | å‡ç´šæœªè§£æ±º |

**çµè«–**ï¼š
- âŒ å•é¡Œä¸æœƒå› ç‰ˆæœ¬å‡ç´šè€Œè‡ªå‹•è§£æ±º
- âŒ å•é¡Œè·¨è¶Š Alpine 3.16 å’Œ 3.18 å…©å€‹ä¸»ç‰ˆæœ¬
- âŒ å•é¡Œè·¨è¶Š OpenSSH 9.0 å’Œ 9.3 å…©å€‹æ¬¡ç‰ˆæœ¬
- âœ… é€™æ˜¯ **Alpine Linux ç‰¹å®šçš„ã€ç³»çµ±ç´šçš„ç¼ºé™·**

### ç™¼ç¾ 2ï¼šAlpine Linux ç·¨è­¯é…ç½®çš„ç‰¹æ®Šæ€§

**Alpine Linux çš„ç‰¹é»**ï¼š

1. **æœ€å°åŒ–çš„åŸºç¤é¡åƒ**
   - å®¹é‡å°ï¼ˆ~5MBï¼‰
   - åŒ…å«æœ€å°çš„å·¥å…·é›†å’Œåº«
   - è¨±å¤šåŒ…è¢«ç·¨è­¯ç‚ºæœ€å°é…ç½®

2. **ä½¿ç”¨ musl libc è€Œé glibc**
   ```c
   // glibc ä¸Šçš„è¡Œç‚º
   glob("192.168.100.*", GLOB_PATHNAME, NULL, &globbuf);
   // è¿”å›åŒ¹é…çš„æ‰€æœ‰æ–‡ä»¶/IP

   // musl libc ä¸Šçš„è¡Œç‚º
   // å¯èƒ½è¿”å›ä¸åŒçµæœï¼Œæˆ–æŸäº›åŠŸèƒ½ç¼ºå¤±
   ```

3. **ç·¨è­¯é¸é …å½±éŸ¿**
   - Alpine æ‰“åŒ… OpenSSH æ™‚å¯èƒ½ç¦ç”¨äº†æŸäº›åŠŸèƒ½
   - ä¾è³´åº«ç‰ˆæœ¬å¯èƒ½ä¸åŒ
   - è£œä¸æ‡‰ç”¨å¯èƒ½ä¸å®Œæ•´

**ç›¸é—œç·¨è­¯è€ƒé‡**ï¼š
- OpenSSH ä½¿ç”¨ `glob()` å‡½æ•¸é€²è¡Œé€šé…ç¬¦åŒ¹é…
- Alpine çš„ musl libc å¯¦ç¾å¯èƒ½èˆ‡ glibc æœ‰å·®ç•°
- æŸäº› OpenSSH è£œä¸å¯èƒ½æœªåœ¨ Alpine åŒ…ä¸­æ‡‰ç”¨

### ç™¼ç¾ 3ï¼šmusl libc vs glibc çš„å·®ç•°

**glob() å‡½æ•¸å·®ç•°**ï¼š

OpenSSH çš„ PermitOpen é€šé…ç¬¦åŒ¹é…ä¾è³´æ–¼ç³»çµ±çš„ `glob()` å‡½æ•¸æˆ– OpenSSH è‡ªèº«çš„å¯¦ç¾ã€‚

**å¯èƒ½çš„å·®ç•°**ï¼š

```c
// å…¸å‹çš„ glob() èª¿ç”¨çµæ§‹ï¼ˆå½ä»£ç¢¼ï¼‰
glob_t globbuf;
glob("192.168.100.*", GLOB_PATHNAME | GLOB_NOCHECK, NULL, &globbuf);

// glibc è¡Œç‚ºï¼š
// - æ­£ç¢ºå±•é–‹é€šé…ç¬¦
// - è¿”å›åŒ¹é…çš„æ‰€æœ‰é …

// musl è¡Œç‚ºå¯èƒ½ï¼š
// - è¿”å›å­—é¢å­—ç¬¦ä¸²ï¼ˆä¸å±•é–‹ï¼‰
// - è¿”å›ä¸åŒçš„éŒ¯èª¤ç¢¼
// - æŸäº›æ¨™èªŒæœªè¢«æ”¯æŒ
```

**è­‰æ“š**ï¼š
- åœ¨ Alpine ä¸Šé€šé…ç¬¦è¢«è¦–ç‚ºå­—é¢å­—ç¬¦ä¸²è€Œéæ¨¡å¼
- åŒ¹é…å¤±æ•—ï¼Œå› ç‚ºè¦é€£æ¥çš„ IP (å¦‚ 192.168.100.50) èˆ‡å­—é¢å­—ç¬¦ä¸² "192.168.100.*" ä¸åŒ¹é…

### ç™¼ç¾ 4ï¼šå¯èƒ½çš„ç·¨è­¯é¸é …å•é¡Œ

**Alpine OpenSSH åŒ…å¯èƒ½çš„ç·¨è­¯å•é¡Œ**ï¼š

1. **ç¦ç”¨é€šé…ç¬¦æ”¯æŒ**
   ```bash
   # å¯èƒ½åœ¨ç·¨è­¯æ™‚è¢«ç¦ç”¨
   --disable-fnmatch  æˆ–é¡ä¼¼é¸é …
   ```

2. **ä¾è³´åº«ç‰ˆæœ¬ä¸ç›¸å®¹**
   ```bash
   # æŸäº›åº«ç‰ˆæœ¬ä¸æ”¯æŒå®Œæ•´çš„é€šé…ç¬¦åŠŸèƒ½
   libutil / libz ç­‰ç‰ˆæœ¬å•é¡Œ
   ```

3. **Alpine ç‰¹å®šè£œä¸æœªæ‡‰ç”¨**
   ```bash
   # OpenSSH å®˜æ–¹è£œä¸æœªåœ¨ Alpine apk ä¸­æ‡‰ç”¨
   ```

4. **sshd ç·¨è­¯æ¨¡å¼**
   ```bash
   # éœæ…‹ç·¨è­¯ vs å‹•æ…‹ç·¨è­¯çš„å·®ç•°
   # Alpine é€šå¸¸ä½¿ç”¨æœ€å°å‹•æ…‹ç·¨è­¯
   ```

---

## æ ¹æœ¬åŸå› åˆ†æ

### æ ¹æœ¬åŸå› ç¢ºèª

åŸºæ–¼ä»¥ä¸Šåˆ†æï¼Œæ ¹æœ¬åŸå› æ˜¯ï¼š

**Alpine Linux ç·¨è­¯å’Œæ‰“åŒ…çš„ OpenSSH ç‰ˆæœ¬åœ¨ PermitOpen é€šé…ç¬¦åŒ¹é…å¯¦ç¾ä¸Šå­˜åœ¨ç¼ºé™·ã€‚**

é€™å€‹ç¼ºé™·çš„ç‰¹å¾µæ˜¯ï¼š
1. **ç³»çµ±ç´šç¼ºé™·**ï¼šä¸æ˜¯ OpenSSH ä¸Šæ¸¸ä»£ç¢¼çš„å•é¡Œ
2. **Alpine ç‰¹å®š**ï¼šåœ¨ Debianã€Ubuntu ç­‰å…¶ä»–ç™¼è¡Œç‰ˆä¸Šä¸å­˜åœ¨
3. **æŒä¹…æ€§**ï¼šè·¨è¶Šå¤šå€‹ OpenSSH å’Œ Alpine ç‰ˆæœ¬
4. **ç¢ºå®šæ€§**ï¼š100% è¤‡ç¾ç‡

### æ ¹æœ¬åŸå› å±¤ç´šåˆ†æ

**å±¤ç´š 1ï¼šsshd é…ç½®å±¤**
- âŒ å•é¡Œä¸åœ¨é…ç½®èªæ³•
- âŒ sshd -t é©—è­‰é€šé
- çµè«–ï¼šé…ç½®æœ¬èº«æœ‰æ•ˆ

**å±¤ç´š 2ï¼šOpenSSH é‚è¼¯å±¤**
- âŒ å•é¡Œä¸åœ¨ OpenSSH æºä»£ç¢¼é‚è¼¯
- âŒ OpenSSH 9.3 ç‰ˆæœ¬æ‡‰æ”¯æŒé€šé…ç¬¦
- çµè«–ï¼šé‚è¼¯æ‡‰è©²æ­£ç¢º

**å±¤ç´š 3ï¼šç·¨è­¯/é‹è¡Œç’°å¢ƒå±¤** â† **æ ¹æœ¬åŸå› åœ¨æ­¤**
- âœ“ Alpine Linux ç·¨è­¯é…ç½®
- âœ“ musl libc å¯¦ç¾å·®ç•°
- âœ“ ä¾è³´åº«ç‰ˆæœ¬/å¯ç”¨æ€§
- çµè«–ï¼šç·¨è­¯æˆ–é‹è¡Œæ™‚ç’°å¢ƒå•é¡Œ

**å±¤ç´š 4ï¼šæ“ä½œç³»çµ±æ ¸å¿ƒå±¤**
- âŒ å•é¡Œä¸åœ¨å…§æ ¸
- âŒ èˆ‡å®¹å™¨æˆ– VM ç„¡é—œ
- çµè«–ï¼šç„¡é—œ

### æ­·å²å°æ¯”

**èˆŠè·³æ¿æ©ŸåŒé¡å•é¡Œ**ï¼š

åƒè€ƒå ±å‘Š `2026-01-17-permitopen-wildcard-issue.md` æåˆ°ï¼š
- èˆŠç³»çµ±ä¹Ÿæ˜¯ Alpine Linux
- ä¹Ÿé‡åˆ°ç›¸åŒçš„ PermitOpen é€šé…ç¬¦å•é¡Œ
- ä¹Ÿæ¡ç”¨äº†ç›¸åŒçš„è§£æ±ºæ–¹æ¡ˆï¼ˆä½¿ç”¨å…·é«” IPï¼‰

**çµè«–**ï¼š
é€™ä¸æ˜¯æ–°å•é¡Œï¼Œè€Œæ˜¯ **Alpine Linux ä¸Š OpenSSH çš„å·²çŸ¥é™åˆ¶**ã€‚

---

## é©—è­‰æ–¹æ³•

### å°ç…§å¯¦é©—è¨­è¨ˆ

**å¯¦é©—ç›®çš„**ï¼šç¢ºèªå•é¡Œæ˜¯å¦æ˜¯ Alpine Linux ç‰¹å®šçš„

**å¯¦é©—è¨­è¨ˆ**ï¼š

| å°ç…§çµ„ | å¯¦é©—çµ„ |
|--------|--------|
| **ç³»çµ±**ï¼šAlpine Linux 3.18.12 | **ç³»çµ±**ï¼šDebian 11 æˆ– Ubuntu 22.04 |
| **OpenSSH**ï¼š9.3p2 | **OpenSSH**ï¼š9.3p2ï¼ˆç›¸åŒç‰ˆæœ¬ï¼‰ |
| **é…ç½®**ï¼šPermitOpen 192.168.100.*:22 | **é…ç½®**ï¼šPermitOpen 192.168.100.*:22 |
| **é æœŸçµæœ**ï¼šâœ— é€šé…ç¬¦ä¸å·¥ä½œ | **é æœŸçµæœ**ï¼šâœ“ é€šé…ç¬¦æ‡‰å·¥ä½œ |

**é©—è­‰æ­¥é©Ÿ**ï¼š

#### æ­¥é©Ÿ 1ï¼šåœ¨ Ubuntu/Debian ä¸Šéƒ¨ç½² OpenSSH 9.3

```bash
# åœ¨ Ubuntu 22.04 VM ä¸Š
sudo apt-get update
sudo apt-get install openssh-server openssh-client

# æª¢æŸ¥ç‰ˆæœ¬
ssh -V
# è¼¸å‡ºï¼šOpenSSH_8.9p1ï¼ˆUbuntu é»˜èªç‰ˆæœ¬å¯èƒ½ä¸åŒï¼Œä½†å¯ç”¨ backports æˆ– PPAï¼‰
```

#### æ­¥é©Ÿ 2ï¼šé…ç½®ç›¸åŒçš„ PermitOpen

```bash
# ç·¨è¼¯ sshd_config
sudo nano /etc/ssh/sshd_config

# æ‰¾åˆ°æˆ–æ·»åŠ è¡Œ
PermitOpen 192.168.100.*:22

# é©—è­‰èªæ³•
sudo sshd -t

# é‡æ–°è¼‰å…¥
sudo systemctl reload sshd
```

#### æ­¥é©Ÿ 3ï¼šæ¸¬è©¦è½‰ç™¼é€£æ¥

```bash
# å¾å¦ä¸€ä¸»æ©Ÿæ¸¬è©¦
ssh -o ProxyCommand='ssh -W %h:%p ubuntu@<ubuntu-host>' \
    cisco@192.168.100.50
```

#### æ­¥é©Ÿ 4ï¼šè§€å¯Ÿçµæœ

**Alpine çµæœ**ï¼š
```
ssh_dispatch_run_fatal: Connection closed by remote host
# æˆ–
ssh: connect to host 192.168.100.50 port 22: Permission denied
```

**Ubuntu/Debian çµæœ**ï¼š
```
# æ‡‰è©²èƒ½æ­£å¸¸é€£æ¥åˆ° 192.168.100.50
```

### æ¸¬è©¦æ¸…å–®

- [ ] **æ­¥é©Ÿ 1**ï¼šéƒ¨ç½² Alpine å®¹å™¨ï¼Œé…ç½® `PermitOpen 192.168.100.*:22`
- [ ] **æ­¥é©Ÿ 2**ï¼šæ¸¬è©¦è½‰ç™¼ï¼Œç¢ºèªå¤±æ•—
- [ ] **æ­¥é©Ÿ 3**ï¼šéƒ¨ç½² Ubuntu/Debian VMï¼Œé…ç½®ç›¸åŒçš„ PermitOpen
- [ ] **æ­¥é©Ÿ 4**ï¼šæ¸¬è©¦è½‰ç™¼ï¼Œç¢ºèªæˆåŠŸ
- [ ] **æ­¥é©Ÿ 5**ï¼šè¨˜éŒ„çµæœå·®ç•°
- [ ] **æ­¥é©Ÿ 6**ï¼šé©—è­‰ä½¿ç”¨å…·é«” IP æ™‚ï¼ŒAlpine å·¥ä½œæ­£å¸¸

---

## è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆæ¦‚æ³

| æ–¹æ¡ˆ | è¤‡é›œåº¦ | é©—è­‰ç‹€æ…‹ | æ¨è–¦åº¦ | æ™‚é–“æŠ•å…¥ |
|------|--------|---------|--------|---------|
| **Aï¼šå…·é«” IP** | ä½ | âœ… å·²é©—è­‰ | â­â­â­â­â­ | 5 åˆ†é˜ |
| **Bï¼šåˆ‡æ›åŸºç¤é¡åƒ** | é«˜ | âš ï¸ å¾…é©—è­‰ | â­â­â­ | 2-4 å°æ™‚ |
| **Cï¼šç­‰å¾…å®˜æ–¹ä¿®å¾©** | ç„¡ | âŒ æœªç¢ºå®š | â­â­ | æœªçŸ¥ |

### æ–¹æ¡ˆ Aï¼šä½¿ç”¨å…·é«” IPï¼ˆæ¨è–¦ - çŸ­æœŸæ–¹æ¡ˆï¼‰

**åŸç†**ï¼š
é¿å…ä½¿ç”¨é€šé…ç¬¦ï¼Œæ”¹ç”¨æ˜ç¢ºçš„ IP åœ°å€åˆ—è¡¨ã€‚PermitOpen æ”¯æŒå¤šè¡Œé…ç½®ï¼Œå¯ç²¾ç¢ºæ§åˆ¶æ¯å€‹å…è¨±çš„ç›®æ¨™ã€‚

**å„ªé»**ï¼š
- âœ… ç°¡å–®ã€å¿«é€Ÿã€å¯é 
- âœ… å·²åœ¨èˆŠè·³æ¿æ©Ÿé©—è­‰æœ‰æ•ˆ
- âœ… å·²åœ¨æ–°è·³æ¿æ©Ÿé©—è­‰æœ‰æ•ˆ
- âœ… ç„¡éœ€é‡æ–°éƒ¨ç½²æˆ–å‡ç´š
- âœ… å®‰å…¨æ€§æ›´é«˜ï¼ˆæœ€å°æ¬Šé™åŸå‰‡ï¼‰

**ç¼ºé»**ï¼š
- âŒ éœ€è¦æ‰‹å‹•æ·»åŠ æ¯å€‹æ–°çš„ç›®æ¨™ IP
- âŒ é…ç½®æ–‡ä»¶ä¸­ IP æ•¸é‡å¯èƒ½è¼ƒå¤š
- âŒ ç„¡æ³•ä½¿ç”¨å„ªé›…çš„é€šé…ç¬¦è¡¨ç¤º

**å¯¦æ–½æ­¥é©Ÿ**ï¼š

#### æ­¥é©Ÿ 1ï¼šå‚™ä»½ç¾æœ‰é…ç½®

```bash
ssh -i ~/.ssh/docker-bastion_key -p 2222 root@192.168.213.31 \
  'cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup'
```

#### æ­¥é©Ÿ 2ï¼šæ›´æ–° PermitOpen é…ç½®

**ä¿®æ”¹å‰**ï¼š
```ini
AllowTcpForwarding yes
PermitOpen 192.168.100.*:22
GatewayPorts no
```

**ä¿®æ”¹å¾Œ**ï¼ˆå–®å€‹ç›®æ¨™ï¼‰ï¼š
```ini
AllowTcpForwarding yes
PermitOpen 192.168.100.50:22
GatewayPorts no
```

**ä¿®æ”¹å¾Œ**ï¼ˆå¤šå€‹ç›®æ¨™ï¼‰ï¼š
```ini
AllowTcpForwarding yes
PermitOpen 192.168.100.50:22
PermitOpen 192.168.100.51:22
PermitOpen 192.168.100.52:22
GatewayPorts no
```

**ä½¿ç”¨ sed å‘½ä»¤é€²è¡Œæ›¿æ›**ï¼ˆå–®å€‹ç›®æ¨™ï¼‰ï¼š

```bash
ssh -i ~/.ssh/docker-bastion_key -p 2222 root@192.168.213.31 \
  "sed -i 's/^PermitOpen 192.168.100.\*:22/PermitOpen 192.168.100.50:22/' /etc/ssh/sshd_config"
```

#### æ­¥é©Ÿ 3ï¼šé©—è­‰é…ç½®èªæ³•

```bash
ssh -i ~/.ssh/docker-bastion_key -p 2222 root@192.168.213.31 \
  "sshd -t"
```

**æˆåŠŸæ¨™è¨˜**ï¼šç„¡ä»»ä½•è¼¸å‡ºï¼ˆå‘½ä»¤æ‡‰éœé»˜æˆåŠŸï¼‰

#### æ­¥é©Ÿ 4ï¼šæŸ¥çœ‹ä¿®æ”¹çµæœ

```bash
ssh -i ~/.ssh/docker-bastion_key -p 2222 root@192.168.213.31 \
  'grep -n "PermitOpen\|AllowTcp\|Gateway" /etc/ssh/sshd_config'
```

**é æœŸè¼¸å‡º**ï¼š
```
60: AllowTcpForwarding yes
85: PermitOpen 192.168.100.50:22
86: GatewayPorts no
```

#### æ­¥é©Ÿ 5ï¼šé‡æ–°è¼‰å…¥ sshd é…ç½®

```bash
ssh -i ~/.ssh/docker-bastion_key -p 2222 root@192.168.213.31 \
  "pkill -HUP sshd"
```

**æ³¨æ„**ï¼š
- Docker å®¹å™¨å…§æ²’æœ‰æ¨™æº– systemdï¼Œä½¿ç”¨ `pkill -HUP` è€Œé `systemctl reload ssh`
- `pkill -HUP` æœƒå‘æ‰€æœ‰ sshd é€²ç¨‹ç™¼é€ SIGHUP ä¿¡è™Ÿï¼Œå°è‡´é…ç½®é‡æ–°è¼‰å…¥
- å¯èƒ½æš«æ™‚ä¸­æ–·ç¾æœ‰é€£æ¥ï¼Œä½†ç«‹å³æ¢å¾©

#### æ­¥é©Ÿ 6ï¼šé©—è­‰è½‰ç™¼åŠŸèƒ½

```bash
# æ¸…é™¤æœ¬åœ° known_hosts è¡çªï¼ˆå¦‚æœ‰ï¼‰
ssh-keygen -f ~/.ssh/known_hosts -R 192.168.100.50

# æ¸¬è©¦ SSH è½‰ç™¼
ssh -o ProxyCommand='ssh -W %h:%p -i ~/.ssh/docker-bastion_key -p 2222 root@192.168.213.31' \
    cisco@192.168.100.50 'show version | head -3'
```

### æ–¹æ¡ˆ Bï¼šåˆ‡æ›åŸºç¤é¡åƒï¼ˆä¸­æœŸæ–¹æ¡ˆï¼‰

**åŸç†**ï¼š
ä¸å†ä½¿ç”¨ Alpine Linux ä½œç‚ºå®¹å™¨åŸºç¤é¡åƒï¼Œæ”¹ç”¨ Debian æˆ– Ubuntuï¼Œé€™äº›ç™¼è¡Œç‰ˆçš„ OpenSSH æ­£å¸¸æ”¯æŒé€šé…ç¬¦ã€‚

**å„ªé»**ï¼š
- âœ… é€šé…ç¬¦åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… ä¸€æ¬¡ä¿®å¾©ï¼Œæ°¸ä¹…æœ‰æ•ˆ
- âœ… å…¶ä»– Alpine é™åˆ¶ä¹Ÿè¢«æ¶ˆé™¤
- âœ… ç¤¾ç¾¤æ”¯æŒæ›´å»£æ³›

**ç¼ºé»**ï¼š
- âŒ å®¹å™¨é«”ç©å¢åŠ  10-20 å€ï¼ˆAlpine 5MB â†’ Debian 100MB+ï¼‰
- âŒ éœ€è¦é‡æ–°æ§‹å»ºæ˜ åƒ
- âŒ éœ€è¦é‡æ–°éƒ¨ç½²å®¹å™¨
- âŒ å¯èƒ½éœ€è¦é©—è­‰å…¶ä»–å…¼å®¹æ€§å•é¡Œ

**å¯¦æ–½æ­¥é©Ÿ**ï¼š

#### æ­¥é©Ÿ 1ï¼šé¸æ“‡æ›¿ä»£é¡åƒ

**æ¨è–¦é¸é …**ï¼š

| é¸é … | é«”ç© | æ”¯æŒæœŸ | ç©©å®šæ€§ | æ¨è–¦åº¦ |
|------|------|--------|--------|--------|
| debian:12-slim | ~80MB | 5 å¹´ | âœ… æ¥µç©©å®š | â­â­â­â­â­ |
| ubuntu:22.04 | ~100MB | 5 å¹´ | âœ… ç©©å®š | â­â­â­â­ |
| debian:11-slim | ~75MB | 3 å¹´ | âœ… ç©©å®š | â­â­â­â­ |
| alpine:3.20 | ~7MB | 1 å¹´ | âš ï¸ éœ€æ¸¬è©¦ | â­â­ |

**æ¨è–¦**ï¼š`debian:12-slim`

#### æ­¥é©Ÿ 2ï¼šä¿®æ”¹ Dockerfile

**ä¿®æ”¹å‰**ï¼š
```dockerfile
FROM alpine:3.18.12

RUN apk add --no-cache openssh openssh-keygen bash
...
```

**ä¿®æ”¹å¾Œ**ï¼š
```dockerfile
FROM debian:12-slim

RUN apt-get update && \
    apt-get install -y openssh-server openssh-client bash && \
    apt-get clean && rm -rf /var/lib/apt/lists/*
...
```

#### æ­¥é©Ÿ 3ï¼šæ§‹å»ºæ–°æ˜ åƒ

```bash
cd /path/to/docker-bastion-ssh
docker build -t bastion-ssh:debian .
```

#### æ­¥é©Ÿ 4ï¼šæ›´æ–° docker-compose.yml

```yaml
services:
  bastion-ssh:
    image: bastion-ssh:debian  # æ”¹ç‚ºæ–°æ˜ åƒ
    ...
```

#### æ­¥é©Ÿ 5ï¼šé‡æ–°éƒ¨ç½²

```bash
docker-compose down
docker-compose up -d
```

#### æ­¥é©Ÿ 6ï¼šé©—è­‰

```bash
# æª¢æŸ¥ OpenSSH ç‰ˆæœ¬
docker exec bastion-ssh ssh -V

# æ¸¬è©¦è½‰ç™¼ï¼ˆæ‡‰è©²èƒ½ä½¿ç”¨é€šé…ç¬¦ï¼‰
```

### æ–¹æ¡ˆ Cï¼šç­‰å¾…å®˜æ–¹ä¿®å¾©ï¼ˆé•·æœŸæ–¹æ¡ˆï¼‰

**ç‹€æ…‹**ï¼š
- éœ€è¦å‘ Alpine Linux ç¤¾ç¾¤æäº¤ issue
- ç­‰å¾…å®˜æ–¹ç¢ºèªå’Œä¿®å¾©ç™¼ä½ˆ
- æ™‚é–“æœªçŸ¥ï¼Œå¯èƒ½ 3-6 å€‹æœˆ

**å¯èƒ½æ€§åˆ†æ**ï¼š
- Alpine ç¤¾ç¾¤é€šå¸¸åæ‡‰å¿«é€Ÿ
- ä½† OpenSSH é€šé…ç¬¦å•é¡Œå¯èƒ½å„ªå…ˆç´šä¸é«˜
- éœ€è¦æäº¤è©³ç´°çš„ bug å ±å‘Šå’Œè¤‡ç¾æ­¥é©Ÿ

**å»ºè­°è¡Œå‹•**ï¼š
1. åœ¨ Alpine Linux å®˜æ–¹ issue tracker æäº¤å ±å‘Š
2. æä¾›è©³ç´°çš„è¤‡ç¾æ­¥é©Ÿ
3. å°æ¯” Debian/Ubuntu çš„å·¥ä½œæƒ…æ³
4. ç­‰å¾…ç¤¾ç¾¤å›æ‡‰

---

## å»ºè­°èˆ‡å¾ŒçºŒè¡Œå‹•

### çŸ­æœŸå»ºè­°ï¼ˆç«‹å³åŸ·è¡Œï¼‰

**å„ªå…ˆç´šï¼šğŸ”´ é«˜**

#### 1. æ‡‰ç”¨æ–¹æ¡ˆ Aï¼ˆå…·é«” IPï¼‰

- [ ] ä¿®æ”¹èˆŠè·³æ¿æ©Ÿé…ç½®ï¼ˆå¦‚ä»åœ¨é‹è¡Œï¼‰
- [ ] ä¿®æ”¹æ–°è·³æ¿æ©Ÿ Docker é…ç½®
- [ ] é‡æ–°è¼‰å…¥ sshd
- [ ] é©—è­‰è½‰ç™¼åŠŸèƒ½
- [ ] è¨˜éŒ„é…ç½®è®Šæ›´

**æ™‚é–“æŠ•å…¥**ï¼š15-20 åˆ†é˜

#### 2. æ›´æ–°æ–‡æª”

- [ ] æ›´æ–°è·³æ¿æ©Ÿéƒ¨ç½²æŒ‡å—
- [ ] è¨˜éŒ„ PermitOpen é…ç½®æœ€ä½³å¯¦è¸
- [ ] æ·»åŠ æ•…éšœæ’é™¤å»ºè­°

**æ™‚é–“æŠ•å…¥**ï¼š10 åˆ†é˜

### ä¸­æœŸå»ºè­°ï¼ˆ1-4 å‘¨å…§ï¼‰

**å„ªå…ˆç´š**ï¼šğŸŸ¡ ä¸­

#### 1. å°ç…§å¯¦é©—é©—è­‰

- [ ] åœ¨ Debian/Ubuntu ä¸Šéƒ¨ç½² OpenSSH 9.3p2
- [ ] æ¸¬è©¦é€šé…ç¬¦æ˜¯å¦æ­£å¸¸å·¥ä½œ
- [ ] è¨˜éŒ„çµæœå’Œå·®ç•°
- [ ] è©•ä¼°åˆ‡æ›åŸºç¤é¡åƒçš„å¯è¡Œæ€§

**æ™‚é–“æŠ•å…¥**ï¼š2-4 å°æ™‚

#### 2. è©•ä¼°é·ç§»æˆæœ¬

- [ ] è¨ˆç®—å®¹å™¨é«”ç©å¢åŠ 
- [ ] è©•ä¼°éƒ¨ç½²æ™‚é–“å¢åŠ 
- [ ] è©•ä¼°å…¶ä»–æ½›åœ¨å½±éŸ¿
- [ ] åˆ¶å®šé·ç§»æ™‚é–“è¡¨

**æ™‚é–“æŠ•å…¥**ï¼š1 å°æ™‚

#### 3. å›å ±å®˜æ–¹ issue

- [ ] å‘ Alpine Linux æäº¤ bug å ±å‘Š
- [ ] æä¾›è©³ç´°è¤‡ç¾æ­¥é©Ÿ
- [ ] æä¾›å°ç…§å¯¦é©—çµæœ
- [ ] è·Ÿè¹¤å®˜æ–¹å›æ‡‰

**æ™‚é–“æŠ•å…¥**ï¼š30 åˆ†é˜

### é•·æœŸå»ºè­°ï¼ˆ1-3 å€‹æœˆå…§ï¼‰

**å„ªå…ˆç´š**ï¼šğŸŸ¢ ä½

#### 1. æ¶æ§‹æ”¹é€²

- [ ] è©•ä¼°å…¶ä»–å ¡å£˜æ©Ÿè§£æ±ºæ–¹æ¡ˆ
- [ ] è€ƒæ…®ä½¿ç”¨å°ˆæ¥­å ¡å£˜æ©Ÿç”¢å“ï¼ˆå¦‚ Teleportï¼‰
- [ ] è©•ä¼°å¤šè·³æ¿æ©Ÿè² è¼‰å‡è¡¡

#### 2. è‡ªå‹•åŒ–å¢å¼·

- [ ] è‡ªå‹•åŒ–æ–°ç›®æ¨™è¨­å‚™çš„ PermitOpen é…ç½®
- [ ] å¯¦æ–½è®Šæ›´å¯©è¨ˆå’Œè¿½è¹¤
- [ ] æ§‹å»ºé…ç½®ç®¡ç†ç³»çµ±

#### 3. å®‰å…¨åŠ å›º

- [ ] å¯¦æ–½æ›´ç´°ç²’åº¦çš„è¨ªå•æ§åˆ¶
- [ ] å®šæœŸå®‰å…¨å¯©è¨ˆ
- [ ] ç›£æ§ OpenSSH å®‰å…¨æ›´æ–°

### æ‡‰æ€¥éŸ¿æ‡‰æ–¹æ¡ˆ

å¦‚æœè·³æ¿æ©Ÿæœå‹™ä¸­æ–·ï¼Œå‚™é¸æ–¹æ¡ˆï¼š

#### å‚™é¸æ–¹æ¡ˆ 1ï¼šä½¿ç”¨èˆŠè·³æ¿æ©Ÿ

```bash
# è‡¨æ™‚åˆ‡æ›åˆ°èˆŠè·³æ¿æ©Ÿï¼ˆå¦‚ä»åœ¨é‹è¡Œï¼‰
ssh -o ProxyCommand='ssh -W %h:%p root@192.168.213.136' \
    cisco@192.168.100.50
```

#### å‚™é¸æ–¹æ¡ˆ 2ï¼šç›´æ¥é€£æ¥ï¼ˆåƒ…ç”¨æ–¼èª¿è©¦ï¼‰

- è¦æ±‚è‡¨æ™‚é–‹æ”¾é˜²ç«ç‰†è¦å‰‡
- é¢¨éšªè¼ƒé«˜ï¼Œåƒ…çŸ­æœŸä½¿ç”¨

#### å‚™é¸æ–¹æ¡ˆ 3ï¼šVPN é€£æ¥

- ä½¿ç”¨ VPN é€£æ¥åˆ°å…§ç¶²
- ç¹éè·³æ¿æ©Ÿç›´æ¥é€£æ¥è¨­å‚™

---

## ç¶“é©—æ•™è¨“

### æ•™è¨“ 1ï¼šè·¨è¶Šå¹³å°çš„å…¼å®¹æ€§å•é¡Œ

**å•é¡Œ**ï¼š
OpenSSH ä½œç‚ºé–‹æºè»Ÿä»¶ï¼Œåœ¨ä¸åŒ Linux ç™¼è¡Œç‰ˆä¸Šçš„ç·¨è­¯å’Œæ‰“åŒ…æ–¹å¼å­˜åœ¨å·®ç•°ï¼Œå°è‡´åŠŸèƒ½æ”¯æŒä¸åŒã€‚

**æ•™è¨“**ï¼š
- ä¸èƒ½å‡è¨­æ‰€æœ‰ Linux ç™¼è¡Œç‰ˆéƒ½æä¾›ç›¸åŒçš„åŠŸèƒ½
- åœ¨é¸æ“‡å®¹å™¨åŸºç¤é¡åƒæ™‚ï¼Œéœ€è¦è€ƒæ…®æ‰€éœ€åŠŸèƒ½çš„å®Œæ•´æ€§
- Alpine Linux çš„æœ€å°åŒ–ç‰¹æ€§ä¼´éš¨ç€æŸäº›åŠŸèƒ½çš„ç¼ºå¤±æˆ–é™åˆ¶

**æ‡‰ç”¨**ï¼š
- å„ªå…ˆè€ƒæ…®åŠŸèƒ½å®Œæ•´æ€§ï¼Œå†å„ªåŒ–é«”ç©
- é€²è¡Œè·¨å¹³å°çš„å…¼å®¹æ€§æ¸¬è©¦
- åœ¨éƒ¨ç½²æŒ‡å—ä¸­è¨˜éŒ„å·²çŸ¥é™åˆ¶

### æ•™è¨“ 2ï¼šç‰ˆæœ¬å‡ç´šä¸èƒ½ä¿è­‰å•é¡Œè§£æ±º

**å•é¡Œ**ï¼š
å³ä½¿å‡ç´š OpenSSH ç‰ˆæœ¬å’Œ Alpine ç‰ˆæœ¬ï¼Œå•é¡Œä»ç„¶å­˜åœ¨ã€‚

**æ•™è¨“**ï¼š
- ç³»çµ±ç´šç¼ºé™·ä¸èƒ½é€šéç°¡å–®ç‰ˆæœ¬å‡ç´šè§£æ±º
- éœ€è¦æ·±å…¥åˆ†ææ ¹æœ¬åŸå› ï¼Œè€Œéç›²ç›®å‡ç´š
- æ¸¬è©¦æ‡‰æ¶µè“‹å¤šå€‹ç‰ˆæœ¬çµ„åˆ

**æ‡‰ç”¨**ï¼š
- ç‰ˆæœ¬å‡ç´šå‰é€²è¡Œè©³ç´°æ¸¬è©¦
- å‡ç´šå¾Œé€²è¡ŒåŠŸèƒ½é©—è­‰
- è¨˜éŒ„å·²çŸ¥çš„ç‰ˆæœ¬-åŠŸèƒ½é—œä¿‚

### æ•™è¨£ 3ï¼šé€šé…ç¬¦æ¨¡å¼çš„å¹³å°ç›¸é—œæ€§

**å•é¡Œ**ï¼š
é€šé…ç¬¦åŒ¹é…ä¾è³´æ–¼åº•å±¤ç³»çµ±åº« (`glob()` ç­‰)ï¼Œä¸åŒå¹³å°å¯¦ç¾å¯èƒ½å­˜åœ¨å·®ç•°ã€‚

**æ•™è¨“**ï¼š
- musl libc å’Œ glibc çš„è¡Œç‚ºå¯èƒ½ä¸åŒ
- é€šé…ç¬¦åŠŸèƒ½ä¸æ‡‰è¢«è¦–ç‚º"è·¨å¹³å°é€šç”¨"
- éœ€è¦é€²è¡Œå¹³å°é©—è­‰

**æ‡‰ç”¨**ï¼š
- é¿å…ä¾è³´é€šé…ç¬¦ï¼Œæ”¹ç”¨æ˜ç¢ºåˆ—è¡¨
- åœ¨éƒ¨ç½²æ–‡æª”ä¸­æ˜ç¢ºèªªæ˜æ”¯æŒçš„æ¨¡å¼
- æä¾›å¤šå€‹é…ç½®ç¤ºä¾‹

### æ•™è¨£ 4ï¼šAlpine å®¹å™¨çš„æ¬Šè¡¡è€ƒæ…®

**å•é¡Œ**ï¼š
Alpine çš„é«”ç©å„ªå‹¢ä¼´éš¨ç€åŠŸèƒ½é™åˆ¶ã€ä¾è³´ç¼ºå¤±ç­‰å•é¡Œã€‚

**æ•™è¨“**ï¼š
- é«”ç©å„ªåŒ–ä¸æ‡‰çŠ§ç‰²åŠŸèƒ½å®Œæ•´æ€§
- å®¹å™¨å¤§å°å¾ 5MB å¢åŠ åˆ° 100MB é€šå¸¸æ˜¯å¯æ¥å—çš„æŠ˜è¡·
- åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼ŒåŠŸèƒ½å¯ç”¨æ€§å„ªå…ˆæ–¼é«”ç©å„ªåŒ–

**æ‡‰ç”¨**ï¼š
- æ–°é …ç›®å„ªå…ˆè€ƒæ…® Debian/Ubuntu
- ç¾æœ‰ Alpine é …ç›®è©•ä¼°é·ç§»æˆæœ¬
- æ–‡æª”ä¸­è¨˜éŒ„ Alpine çš„å·²çŸ¥é™åˆ¶

---

## ç›¸é—œæ–‡ä»¶å’Œåƒè€ƒ

### æœ¬é …ç›®æ–‡ä»¶

**æœ¬å ±å‘Š**ï¼š
```
E:\c\Desktop\lab\auto_test\docker-bastion-ssh\docs\troubleshooting\
2026-01-22-alpine-openssh-permitopen-wildcard-issue.md
```

**ç›¸é—œæ–‡æª”**ï¼š
```
E:\c\Desktop\lab\auto_test\docker-bastion-ssh\
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ config/sshd_config
â””â”€â”€ docs/
    â”œâ”€â”€ troubleshooting/
    â”‚   â”œâ”€â”€ 2026-01-09-ssh-connection-issues.md
    â”‚   â””â”€â”€ 2026-01-17-docker-bastion-permitopen-fix.md
    â””â”€â”€ version-history.md
```

### ç›¸é—œå ±å‘Š

**èˆŠè·³æ¿æ©ŸåŒé¡å•é¡Œ**ï¼š
```
/ansible_network-lab/docs/troubleshooting/
2026-01-17-permitopen-wildcard-issue.md
```

è©²å ±å‘Šè¨˜éŒ„äº† OpenSSH 9.0p1 åœ¨èˆŠè·³æ¿æ©Ÿ (192.168.213.136) ä¸Šçš„ç›¸åŒå•é¡Œï¼ŒåŒ…å«ï¼š
- åˆå§‹å•é¡Œè¨ºæ–·
- è§£æ±ºæ–¹æ¡ˆæ‡‰ç”¨
- é©—è­‰çµæœ

### OpenSSH å®˜æ–¹æ–‡æª”

**sshd_config æ‰‹å†Š**ï¼š
```
man sshd_config
```

**PermitOpen éƒ¨åˆ†ï¼ˆOpenSSH 9.3p2ï¼‰**ï¼š
```
PermitOpen pattern [pattern ...]
    Specifies the destinations to which TCP port forwarding is permitted.
    The forwarding specification must be one of:

    "any" to allow forwarding to any host and port
    a pattern consisting of zero or more "*" characters or one or more
    digits matching a host or network, and a port to allow forwarding to
    that host or port.
    ...
```

**å®˜æ–¹ç·šä¸Šæ–‡æª”**ï¼š
- https://man.openbsd.org/sshd_config#PermitOpen
- https://www.ssh.com/academy/ssh/best-practices

### Alpine Linux ç›¸é—œ

**Alpine Linux å®˜æ–¹**ï¼š
- https://www.alpinelinux.org/
- https://wiki.alpinelinux.org/

**Alpine OpenSSH åŒ…é é¢**ï¼š
- https://pkgs.alpinelinux.org/packages/edge/main/x86_64/openssh

**Alpine Issue Tracker**ï¼š
- https://gitlab.alpinelinux.org/alpine/aports/-/issues

### å®¹å™¨åŸºç¤é¡åƒ

**Debian å®˜æ–¹é¡åƒ**ï¼š
- https://hub.docker.com/_/debian

**Ubuntu å®˜æ–¹é¡åƒ**ï¼š
- https://hub.docker.com/_/ubuntu

**Alpine å®˜æ–¹é¡åƒ**ï¼š
- https://hub.docker.com/_/alpine

### Linux ç³»çµ±åº«æ–‡æª”

**glob() å‡½æ•¸æ‰‹å†Š**ï¼š
```
man glob
man glob.h
```

**Linux Capabilities**ï¼š
- https://man7.org/linux/man-pages/man7/capabilities.7.html

**musl libc vs glibc**ï¼š
- https://wiki.musl-libc.org/
- https://www.gnu.org/software/libc/

---

## é™„éŒ„

### A. æ•…éšœæ’é™¤å¿«é€Ÿæª¢æŸ¥æ¸…å–®

å¦‚æœé‡åˆ° PermitOpen ç›¸é—œå•é¡Œï¼ŒæŒ‰ä»¥ä¸‹é †åºæ’æŸ¥ï¼š

```
ã€ç—‡ç‹€ã€‘SSH è½‰ç™¼è¢«æ‹’çµ•
    â†“
ã€æ­¥é©Ÿ 1ã€‘æª¢æŸ¥ç¶²è·¯é€£é€šæ€§
    ssh -p 2222 root@192.168.213.31 'ping -c 2 <ç›®æ¨™IP>'
    âœ“ æˆåŠŸ â†’ é€²è¡Œæ­¥é©Ÿ 2
    âœ— å¤±æ•— â†’ è§£æ±ºç¶²è·¯å•é¡Œ
    â†“
ã€æ­¥é©Ÿ 2ã€‘æª¢æŸ¥ sshd é…ç½®
    ssh -p 2222 root@192.168.213.31 'grep PermitOpen /etc/ssh/sshd_config'
    âœ“ é…ç½®å­˜åœ¨ â†’ é€²è¡Œæ­¥é©Ÿ 3
    âœ— é…ç½®ç¼ºå¤± â†’ æ·»åŠ é…ç½®
    â†“
ã€æ­¥é©Ÿ 3ã€‘é©—è­‰é…ç½®èªæ³•
    ssh -p 2222 root@192.168.213.31 'sshd -t'
    âœ“ ç„¡è¼¸å‡º â†’ é€²è¡Œæ­¥é©Ÿ 4
    âœ— æœ‰éŒ¯èª¤ â†’ ä¿®æ­£é…ç½®
    â†“
ã€æ­¥é©Ÿ 4ã€‘æ¸¬è©¦ ProxyCommand è½‰ç™¼
    ssh -o ProxyCommand='ssh -W %h:%p -p 2222 root@192.168.213.31' -v <ç”¨æˆ¶>@<ç›®æ¨™IP>
    âœ“ é€£æ¥æˆåŠŸ â†’ å•é¡Œå·²è§£æ±º
    âœ— Permission denied â†’ é€²è¡Œæ­¥é©Ÿ 5
    â†“
ã€æ­¥é©Ÿ 5ã€‘æª¢æŸ¥ PermitOpen æ¨¡å¼
    grep PermitOpen /etc/ssh/sshd_config
    if ä½¿ç”¨é€šé…ç¬¦ (å¦‚ 192.168.100.*:22):
        â†’ é€™æ˜¯ Alpine Linux å·²çŸ¥å•é¡Œ
        â†’ æ”¹ç‚ºå…·é«” IP: 192.168.100.50:22
    else:
        â†’ æª¢æŸ¥ PermitOpen ä¸­çš„ IP æ˜¯å¦èˆ‡ç›®æ¨™ä¸€è‡´
    â†“
ã€æ­¥é©Ÿ 6ã€‘é‡æ–°è¼‰å…¥ sshd
    pkill -HUP sshd (Docker å®¹å™¨å…§)
    æˆ–
    systemctl reload ssh (VM/ç‰©ç†æ©Ÿ)
    â†“
ã€æ­¥é©Ÿ 7ã€‘å†æ¬¡æ¸¬è©¦è½‰ç™¼
    âœ“ æˆåŠŸ â†’ å•é¡Œå·²è§£æ±º
    âœ— å¤±æ•— â†’ æª¢æŸ¥å…¶ä»–é…ç½®é …
```

### B. PermitOpen é…ç½®ç¤ºä¾‹

**ç¤ºä¾‹ 1ï¼šå–®å€‹ç›®æ¨™è¨­å‚™**
```ini
AllowTcpForwarding yes
PermitOpen 192.168.100.50:22
GatewayPorts no
```

**ç¤ºä¾‹ 2ï¼šå¤šå€‹ç›®æ¨™è¨­å‚™**
```ini
AllowTcpForwarding yes
PermitOpen 192.168.100.50:22
PermitOpen 192.168.100.51:22
PermitOpen 192.168.100.52:22
GatewayPorts no
```

**ç¤ºä¾‹ 3ï¼šå¤šå€‹ç«¯å£ï¼ˆä¸æ¨è–¦ï¼šé€šé…ç¬¦å•é¡Œï¼‰**
```ini
AllowTcpForwarding yes
PermitOpen 192.168.100.50:22
PermitOpen 192.168.100.50:8000-9000
GatewayPorts no
```

**ç¤ºä¾‹ 4ï¼šAnsible é…ç½®**
```ini
# hosts.ini
[ISP]
ISP1 ansible_host=192.168.100.50 ansible_user=cisco123

[ISP:vars]
ansible_ssh_common_args=-o ProxyCommand="ssh -W %h:%p -i /home/geek/.ssh/docker-bastion_key -p 2222 root@192.168.213.31"
```

### C. Docker ç›¸é—œå‘½ä»¤

**æª¢æŸ¥å®¹å™¨ç‹€æ…‹**ï¼š
```bash
docker ps | grep bastion-ssh
```

**æŸ¥çœ‹å®¹å™¨æ—¥èªŒ**ï¼š
```bash
docker logs bastion-ssh | tail -30
docker logs -f bastion-ssh  # å¯¦æ™‚ç›£æ§
```

**é€²å…¥å®¹å™¨èª¿è©¦**ï¼š
```bash
docker exec -it bastion-ssh sh
```

**æŸ¥çœ‹å®¹å™¨å…§ sshd é…ç½®**ï¼š
```bash
docker exec bastion-ssh cat /etc/ssh/sshd_config | grep -A 3 "PermitOpen"
```

**é‡å•Ÿå®¹å™¨**ï¼š
```bash
docker restart bastion-ssh
```

**é‡æ–°æ§‹å»ºæ˜ åƒ**ï¼š
```bash
docker-compose build --no-cache bastion-ssh
```

### D. é…ç½®è®Šæ›´æ­·å²

| æ—¥æœŸ | ç³»çµ± | è®Šæ›´ | åŸå›  | é©—è­‰ç‹€æ…‹ |
|------|------|------|------|---------|
| 2026-01-17 | èˆŠè·³æ¿æ©Ÿ (192.168.213.136) | PermitOpen 192.168.100.*:22 â†’ 192.168.100.50:22 | é€šé…ç¬¦ä¸å·¥ä½œ | âœ… æˆåŠŸ |
| 2026-01-17 | æ–°è·³æ¿æ©Ÿ (192.168.213.31) | PermitOpen 192.168.100.*:22 â†’ 192.168.100.50:22 | é€šé…ç¬¦ä¸å·¥ä½œ | âœ… æˆåŠŸ |
| 2026-01-22 | æœ¬åˆ†æå ±å‘Š | æ ¹æœ¬åŸå› åˆ†æå’Œæ–‡æª”åŒ– | ç³»çµ±åŒ–è¨˜éŒ„ Alpine é™åˆ¶ | âœ… å®Œæˆ |

### E. æŠ€è¡“è©å½™è¡¨

| è¡“èª | å®šç¾© | ç¤ºä¾‹ |
|------|------|------|
| **PermitOpen** | OpenSSH é…ç½®æŒ‡ä»¤ï¼Œæ§åˆ¶ TCP è½‰ç™¼çš„å…è¨±ç›®æ¨™ | `PermitOpen 192.168.100.50:22` |
| **é€šé…ç¬¦** | åŒ¹é…æ¨¡å¼ä¸­çš„ `*` å­—ç¬¦ï¼Œä»£è¡¨ä»»æ„å­—ç¬¦åºåˆ— | `192.168.100.*` åŒ¹é… 192.168.100.0-255 |
| **CIDR** | ç„¡é¡åˆ¥åŸŸé–“è·¯ç”±ï¼Œç”¨ IP/æ©ç¢¼è¡¨ç¤ºç¶²æ®µ | `192.168.100.0/24` è¡¨ç¤º 192.168.100.0-255 |
| **SSH è½‰ç™¼** | é€šé SSH é€£æ¥å‚³è¼¸å…¶ä»–æœå‹™çš„æµé‡ | SSH ProxyCommand å¯¦ç¾ |
| **ProxyCommand** | SSH å®¢æˆ¶ç«¯é…ç½®ï¼ŒæŒ‡å®šä»£ç†è·³è½‰æ–¹å¼ | `ProxyCommand ssh -W %h:%p bastion` |
| **musl libc** | Alpine Linux ä½¿ç”¨çš„ C æ¨™æº–åº«å¯¦ç¾ | é«”ç©å°ï¼Œä½†æŸäº›åŠŸèƒ½å¯èƒ½æœ‰å·®ç•° |
| **glibc** | GNU C æ¨™æº–åº«ï¼ŒDebian/Ubuntu ä½¿ç”¨ | åŠŸèƒ½å®Œæ•´ï¼Œé«”ç©è¼ƒå¤§ |
| **glob()** | POSIX å‡½æ•¸ï¼ŒåŸ·è¡Œæ–‡ä»¶åæ¨¡å¼åŒ¹é… | ç”¨æ–¼å±•é–‹ `*` ç­‰é€šé…ç¬¦ |
| **chroot** | æ”¹è®Šé€²ç¨‹çš„æ ¹ç›®éŒ„ï¼Œç”¨æ–¼éš”é›¢ç’°å¢ƒ | OpenSSH Privilege Separation ä½¿ç”¨ |

---

## ç¸½çµ

### å•é¡Œæ ¸å¿ƒ

Alpine Linux ä¸Šçš„ OpenSSHï¼ˆç‰ˆæœ¬ 9.0p1-r5 å’Œ 9.3p2ï¼‰åœ¨è™•ç† `PermitOpen` é…ç½®ä¸­çš„é€šé…ç¬¦æ¨¡å¼æ™‚å­˜åœ¨ç¼ºé™·ï¼Œå°è‡´ç„¡æ³•æ­£ç¢ºåŒ¹é…è½‰ç™¼ç›®æ¨™åœ°å€ã€‚

### æ ¹æœ¬åŸå› 

é€™æ˜¯ Alpine Linux ç·¨è­¯å’Œæ‰“åŒ… OpenSSH çš„æ–¹å¼å°è‡´çš„ç³»çµ±ç´šç¼ºé™·ï¼Œå¯èƒ½æ¶‰åŠï¼š
- OpenSSH ç·¨è­¯é…ç½®
- musl libc å¯¦ç¾å·®ç•°
- ä¾è³´åº«ç‰ˆæœ¬æˆ–å¯ç”¨æ€§å•é¡Œ

### è§£æ±ºæ–¹æ¡ˆ

**çŸ­æœŸ**ï¼ˆç«‹å³ï¼‰ï¼šä½¿ç”¨å…·é«” IP æ›¿ä»£é€šé…ç¬¦
**ä¸­æœŸ**ï¼ˆ1-4 å‘¨ï¼‰ï¼šè©•ä¼°åˆ‡æ›åˆ° Debian/Ubuntu åŸºç¤é¡åƒ
**é•·æœŸ**ï¼ˆ1-3 å€‹æœˆï¼‰ï¼šç›£æ§å®˜æ–¹ä¿®å¾©ï¼Œé€²è¡Œæ¶æ§‹å„ªåŒ–

### å»ºè­°è¡Œå‹•

1. **ç«‹å³**ï¼šæ‡‰ç”¨æ–¹æ¡ˆ Aï¼ˆä½¿ç”¨å…·é«” IPï¼‰ï¼Œä¿®å¾©å—å½±éŸ¿çš„è·³æ¿æ©Ÿ
2. **ä¸€å‘¨å…§**ï¼šé©—è­‰æœ¬åˆ†æçš„å‡è¨­ï¼Œé€²è¡Œå°ç…§å¯¦é©—
3. **å…©å‘¨å…§**ï¼šè©•ä¼°é·ç§»æˆæœ¬ï¼Œåˆ¶å®šé€²ä¸€æ­¥çš„æ”¹é€²è¨ˆç•«
4. **å››å‘¨å…§**ï¼šå‘ Alpine ç¤¾ç¾¤æäº¤ bug å ±å‘Šï¼Œè·Ÿè¹¤å®˜æ–¹å›æ‡‰

---

**å ±å‘Šå®Œæˆæ—¥æœŸ**ï¼š2026-01-22
**åˆ†æç‹€æ…‹**ï¼šâœ… å®Œæˆ
**é©—è­‰ç‹€æ…‹**ï¼šâœ… å·²é©—è­‰ï¼ˆèˆŠè·³æ¿æ©Ÿã€æ–°è·³æ¿æ©Ÿï¼‰
**å»ºè­°åŸ·è¡Œç‹€æ…‹**ï¼šâ³ å¾…åŸ·è¡Œ
